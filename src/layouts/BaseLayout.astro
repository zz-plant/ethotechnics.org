---
import "@fontsource-variable/plus-jakarta-sans";
import "@fontsource-variable/source-serif-4";
import { SEO } from "astro-seo";
import { ClientRouter } from "astro:transitions";
import Navigation from "../components/Navigation.astro";
import Wordmark from "../components/Wordmark.astro";
import { siteFooter } from "../content/site-footer";
import "../styles/theme.css";
import "../styles/global.css";

interface Props {
  title?: string;
  description?: string;
  /**
   * Optional class list for the <main> wrapper. Defaults to the standard
   * constrained layout (`"page container"`). Pass a custom value such as
   * "page page--wide" to allow full-bleed or alternative padding.
   */
  mainClass?: string;
}

const siteName = "Ethotechnics Institute";
const defaultTitle =
  "Ethotechnics Institute â€” The Reference Standard for Accountable Systems";
const defaultDescription =
  "Ethotechnics.org is the Institute: standards, mechanisms, and validators for accountable system governance.";

const {
  title = defaultTitle,
  description = defaultDescription,
  mainClass = "page container",
} = Astro.props as Props;
const canonical = Astro.site
  ? new URL(Astro.url.pathname, Astro.site).toString()
  : Astro.url.href;
const siteBase = Astro.site ? Astro.site.toString() : Astro.url.origin;
const seoImage = {
  src: new URL("/assets/ethotechnics-hero-map.svg", siteBase).toString(),
  alt: "Linework illustration of Ethotechnics focus areas",
  width: 1200,
  height: 630,
};
const structuredData: Array<Record<string, unknown>> = [
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    name: siteName,
    url: siteBase,
    sameAs: [
      "https://ethotechnics.com",
      "https://signals.ethotechnics.org",
      "https://github.com/ethotechnics",
    ],
  },
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    name: siteName,
    url: siteBase,
    potentialAction: {
      "@type": "SearchAction",
      target: `${new URL("/search", siteBase).toString()}?q={search_term_string}`,
      "query-input": "required name=search_term_string",
    },
  },
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    name: title,
    description,
    url: canonical,
    inLanguage: "en",
    isPartOf: {
      "@type": "WebSite",
      name: siteName,
      url: siteBase,
    },
    primaryImageOfPage: {
      "@type": "ImageObject",
      url: seoImage.src,
      width: seoImage.width,
      height: seoImage.height,
    },
  },
];
const structuredDataJson = JSON.stringify(structuredData);
const { identity, navigation } = siteFooter;
const { cspNonce } = Astro.locals;
const currentPath = Astro.url.pathname;

const pathSegments = currentPath.split("/").filter(Boolean);
if (pathSegments.length > 0) {
  const breadcrumbItems = pathSegments.map((segment, index) => {
    const url = new URL(
      `${pathSegments.slice(0, index + 1).join("/")}`,
      siteBase,
    ).toString();
    const formattedSegment = segment
      .split("-")
      .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
      .join(" ");
    return {
      "@type": "ListItem",
      position: index + 1,
      name: formattedSegment,
      item: url,
    };
  });

  structuredData.push({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: breadcrumbItems,
  });
}
---

<!doctype html>
<html lang="en" id="top">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <ClientRouter />
    <SEO
      title={title}
      titleDefault={defaultTitle}
      description={description}
      canonical={canonical}
      languageAlternates={[{ hrefLang: "en", href: canonical }]}
      openGraph={{
        basic: {
          title,
          type: "website",
          image: seoImage.src,
          url: canonical,
        },
        optional: {
          description,
          locale: "en_US",
          siteName,
        },
        image: {
          alt: seoImage.alt,
          secureUrl: seoImage.src,
          type: "image/svg+xml",
          width: seoImage.width,
          height: seoImage.height,
        },
      }}
      twitter={{
        card: "summary_large_image",
        title,
        description,
        image: seoImage.src,
        imageAlt: seoImage.alt,
      }}
      extend={{
        link: [
          { rel: "icon", type: "image/svg+xml", href: "/favicon.svg" },
          { rel: "manifest", href: "/site.webmanifest" },
        ],
        meta: [{ name: "theme-color", content: "#ffffff" }],
      }}
    />
    <script
      type="application/ld+json"
      nonce={cspNonce}
      set:html={structuredDataJson}
      is:inline
    />
    <slot name="head" />
  </head>
  <body>
    <svg aria-hidden="true" focusable="false" class="svg-defs">
      <defs>
        <filter id="paper-grain" x="0" y="0" width="100%" height="100%">
          <feTurbulence
            type="fractalNoise"
            baseFrequency="0.8"
            numOctaves="3"
            seed="4"
            stitchTiles="stitch"></feTurbulence>
          <feColorMatrix type="saturate" values="0"></feColorMatrix>
          <feComponentTransfer>
            <feFuncR type="linear" slope="0.3" intercept="0.45"></feFuncR>
            <feFuncG type="linear" slope="0.3" intercept="0.45"></feFuncG>
            <feFuncB type="linear" slope="0.3" intercept="0.45"></feFuncB>
          </feComponentTransfer>
        </filter>
        <filter id="ink-hatch" x="0" y="0" width="100%" height="100%">
          <feTurbulence
            type="fractalNoise"
            baseFrequency="0.9"
            numOctaves="2"
            seed="8"
            stitchTiles="stitch"
            result="grain"></feTurbulence>
          <feColorMatrix in="grain" type="saturate" values="0" result="mono"
          ></feColorMatrix>
          <feComponentTransfer in="mono" result="ink">
            <feFuncR type="linear" slope="0.25" intercept="0.25"></feFuncR>
            <feFuncG type="linear" slope="0.25" intercept="0.25"></feFuncG>
            <feFuncB type="linear" slope="0.25" intercept="0.25"></feFuncB>
          </feComponentTransfer>
        </filter>
        <filter id="ink-bleed">
          <feTurbulence
            type="fractalNoise"
            baseFrequency="0.8"
            numOctaves="3"
            result="noise"></feTurbulence>
          <feDisplacementMap
            in="SourceGraphic"
            in2="noise"
            scale="2"
            xChannelSelector="R"
            yChannelSelector="G"></feDisplacementMap>
          <feGaussianBlur stdDeviation="0.5"></feGaussianBlur>
        </filter>
        <symbol id="diagram-stoppability" viewBox="0 0 120 80">
          <rect
            x="10"
            y="30"
            width="70"
            height="20"
            rx="10"
            class="diagram-track"></rect>
          <circle cx="40" cy="40" r="22" class="diagram-stop"></circle>
          <line x1="85" y1="40" x2="110" y2="40" class="diagram-flow"></line>
          <path d="M40 28 L48 40 L40 52 L32 40 Z" class="diagram-stop-symbol"
          ></path>
        </symbol>
        <symbol id="diagram-reversibility" viewBox="0 0 120 80">
          <path
            d="M70 24c12 4 20 15 18 27-2 15-17 27-34 22-17-5-24-25-14-40 8-12 24-16 37-10"
            class="diagram-loop"></path>
          <polyline points="70,24 70,42 52,42" class="diagram-loop-arrow"
          ></polyline>
        </symbol>
        <symbol id="diagram-fair-burden" viewBox="0 0 120 80">
          <line x1="20" y1="40" x2="100" y2="40" class="diagram-scale"></line>
          <circle cx="40" cy="40" r="16" class="diagram-scale-pan"></circle>
          <circle cx="80" cy="40" r="16" class="diagram-scale-pan"></circle>
          <rect x="56" y="18" width="8" height="44" class="diagram-pivot"
          ></rect>
        </symbol>
        <symbol id="diagram-contestability" viewBox="0 0 120 80">
          <path
            d="M24 64 L24 20 L48 20 L48 40 L72 40 L72 20 L96 20 L96 64"
            class="diagram-portal"></path>
          <circle cx="48" cy="52" r="8" class="diagram-voice"></circle>
          <line x1="48" y1="52" x2="64" y2="52" class="diagram-voice-line"
          ></line>
        </symbol>
        <symbol id="diagram-explainability" viewBox="0 0 120 80">
          <rect
            x="18"
            y="18"
            width="84"
            height="44"
            rx="10"
            class="diagram-card"></rect>
          <circle cx="40" cy="40" r="10" class="diagram-focus"></circle>
          <line x1="52" y1="30" x2="84" y2="30" class="diagram-detail"></line>
          <line x1="52" y1="40" x2="84" y2="40" class="diagram-detail"></line>
          <line x1="52" y1="50" x2="74" y2="50" class="diagram-detail"></line>
        </symbol>
        <symbol id="diagram-mpi" viewBox="0 0 120 80">
          <polyline
            points="16,58 40,36 60,44 84,24 104,32"
            class="diagram-metric"></polyline>
          <circle cx="40" cy="36" r="5" class="diagram-metric-point"></circle>
          <circle cx="84" cy="24" r="5" class="diagram-metric-point"></circle>
        </symbol>
        <symbol id="diagram-time-to-halt" viewBox="0 0 120 80">
          <line x1="20" y1="50" x2="100" y2="50" class="diagram-axis"></line>
          <circle cx="40" cy="50" r="6" class="diagram-event"></circle>
          <rect x="40" y="32" width="46" height="12" class="diagram-timer"
          ></rect>
          <polygon points="86,38 100,50 86,62" class="diagram-stop-flag"
          ></polygon>
        </symbol>
      </defs>
    </svg>
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="page-shell">
      <Navigation currentPath={currentPath} />
      <div class="page-shell__canvas">
        <div class="page-shell__panel">
          <main id="main-content" class={mainClass} tabindex="-1">
            <slot />
          </main>
          <footer class="footer container" aria-label="Site footer">
            <section class="footer__section">
              <h2 class="eyebrow footer__heading">{identity.heading}</h2>
              <div class="footer__identity">
                <a
                  class="footer__brand"
                  href={identity.brand.href}
                  aria-label={identity.brand.ariaLabel}
                >
                  <img
                    src={identity.brand.logoSrc}
                    alt={identity.brand.logoAlt}
                    class="footer__logo"
                    loading="lazy"
                    width="38"
                    height="38"
                  />
                  <Wordmark
                    class="footer__wordmark"
                    title={identity.brand.name}
                  />
                </a>
                <p class="muted">{identity.description}</p>
                <a
                  class="footer__link"
                  href={identity.license.href}
                  rel={identity.license.external
                    ? "noopener noreferrer"
                    : undefined}
                  target={identity.license.external ? "_blank" : undefined}
                >
                  {identity.license.label}
                </a>
                <a
                  class="footer__badge"
                  href={identity.license.href}
                  rel={identity.license.external
                    ? "noopener noreferrer"
                    : undefined}
                  target={identity.license.external ? "_blank" : undefined}
                >
                  <img
                    src={identity.licenseBadge.src}
                    alt={identity.licenseBadge.alt}
                    loading="lazy"
                    width="88"
                    height="31"
                  />
                </a>
              </div>
            </section>
            {
              navigation.map((section) => (
                <section class="footer__section">
                  <h2 class="eyebrow footer__heading">{section.heading}</h2>
                  <ul class="footer__list">
                    {section.links.map((link) => (
                      <li>
                        <a
                          class="footer__link"
                          href={link.href}
                          rel={
                            link.external ? "noopener noreferrer" : undefined
                          }
                          target={link.external ? "_blank" : undefined}
                        >
                          {link.label}
                        </a>
                      </li>
                    ))}
                  </ul>
                </section>
              ))
            }
          </footer>
        </div>
      </div>
    </div>
  </body>
</html>
