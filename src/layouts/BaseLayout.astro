---
import { SEO } from 'astro-seo';
import { ViewTransitions } from 'astro:transitions';
import Navigation from '../components/Navigation.astro';
import { siteFooter } from '../content/site-footer';
import '../styles/theme.css';
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
  /**
   * Optional class list for the <main> wrapper. Defaults to the standard
   * constrained layout (`"page container"`). Pass a custom value such as
   * "page page--wide" to allow full-bleed or alternative padding.
   */
  mainClass?: string;
}

const siteName = 'Ethotechnics Institute';
const defaultTitle =
  'Ethotechnics Institute â€” The Reference Standard for Accountable Systems';
const defaultDescription =
  'Ethotechnics.org is the Institute: standards, mechanisms, and validators for accountable system governance.';

const { title = defaultTitle, description = defaultDescription, mainClass = 'page container' } =
  Astro.props as Props;
const canonical = Astro.site ? new URL(Astro.url.pathname, Astro.site).toString() : Astro.url.href;
const siteBase = Astro.site ? Astro.site.toString() : Astro.url.origin;
const seoImage = {
  src: new URL('/assets/ethotechnics-hero-map.svg', siteBase).toString(),
  alt: 'Linework illustration of Ethotechnics focus areas',
  width: 1200,
  height: 630,
};
const structuredData = [
  {
    '@context': 'https://schema.org',
    '@type': 'Organization',
    name: siteName,
    url: siteBase,
    sameAs: ['https://ethotechnics.com', 'https://signals.ethotechnics.org', 'https://github.com/ethotechnics'],
  },
  {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: siteName,
    url: siteBase,
    potentialAction: {
      '@type': 'SearchAction',
      target: `${new URL('/glossary', siteBase).toString()}?query={search_term_string}`,
      'query-input': 'required name=search_term_string',
    },
  },
];
const structuredDataJson = JSON.stringify(structuredData);
const { identity, navigation } = siteFooter;
const { cspNonce } = Astro.locals;
const currentPath = Astro.url.pathname;
---
<!doctype html>
<html lang="en" id="top">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <ViewTransitions />
    <SEO
      title={title}
      titleDefault={defaultTitle}
      description={description}
      canonical={canonical}
      languageAlternates={[{ hrefLang: 'en', href: canonical }]}
      openGraph={{
        basic: {
          title,
          type: 'website',
          image: seoImage.src,
          url: canonical,
        },
        optional: {
          description,
          locale: 'en_US',
          siteName,
        },
        image: {
          alt: seoImage.alt,
          secureUrl: seoImage.src,
          type: 'image/svg+xml',
          width: seoImage.width,
          height: seoImage.height,
        },
      }}
      twitter={{
        card: 'summary_large_image',
        title,
        description,
        image: seoImage.src,
        imageAlt: seoImage.alt,
      }}
      extend={{
        link: [
          { rel: 'icon', type: 'image/svg+xml', href: '/favicon.svg' },
        ],
        meta: [{ name: 'theme-color', content: '#ffffff' }],
      }}
    />
    <script
      type="application/ld+json"
      nonce={cspNonce}
      set:html={structuredDataJson}
      is:inline
    ></script>
    <slot name="head" />
  </head>
  <body>
    <svg aria-hidden="true" focusable="false" class="svg-defs">
      <defs>
        <filter id="paper-grain" x="0" y="0" width="100%" height="100%">
          <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" seed="4" stitchTiles="stitch" />
          <feColorMatrix type="saturate" values="0" />
          <feComponentTransfer>
            <feFuncR type="linear" slope="0.3" intercept="0.45" />
            <feFuncG type="linear" slope="0.3" intercept="0.45" />
            <feFuncB type="linear" slope="0.3" intercept="0.45" />
          </feComponentTransfer>
        </filter>
        <filter id="ink-hatch" x="0" y="0" width="100%" height="100%">
          <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" seed="8" stitchTiles="stitch" result="grain" />
          <feColorMatrix in="grain" type="saturate" values="0" result="mono" />
          <feComponentTransfer in="mono" result="ink">
            <feFuncR type="linear" slope="0.25" intercept="0.25" />
            <feFuncG type="linear" slope="0.25" intercept="0.25" />
            <feFuncB type="linear" slope="0.25" intercept="0.25" />
          </feComponentTransfer>
        </filter>
      </defs>
    </svg>
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="page-shell">
      <Navigation currentPath={currentPath} cspNonce={cspNonce} />
      <div class="page-shell__canvas">
        <div class="page-shell__panel">
          <main id="main-content" class={mainClass} tabindex="-1">
            <slot />
          </main>
          <footer class="footer container" aria-label="Site footer">
            <section class="footer__section">
              <h2 class="eyebrow footer__heading">{identity.heading}</h2>
              <div class="footer__identity">
                <a class="footer__brand" href={identity.brand.href} aria-label={identity.brand.ariaLabel}>
                  <img
                    src={identity.brand.logoSrc}
                    alt={identity.brand.logoAlt}
                    class="footer__logo"
                    loading="lazy"
                  />
                  <span class="footer__brand-name">{identity.brand.name}</span>
                </a>
                <p class="muted">{identity.description}</p>
                <a
                  class="footer__link"
                  href={identity.license.href}
                  rel={identity.license.external ? 'noreferrer' : undefined}
                  target={identity.license.external ? '_blank' : undefined}
                >
                  {identity.license.label}
                </a>
                <a
                  class="footer__badge"
                  href={identity.license.href}
                  rel={identity.license.external ? 'noreferrer' : undefined}
                  target={identity.license.external ? '_blank' : undefined}
                >
                  <img
                    src={identity.licenseBadge.src}
                    alt={identity.licenseBadge.alt}
                    loading="lazy"
                  />
                </a>
              </div>
            </section>
            {navigation.map((section) => (
              <section class="footer__section">
                <h2 class="eyebrow footer__heading">{section.heading}</h2>
                <ul class="footer__list">
                  {section.links.map((link) => (
                    <li>
                      <a
                        class="footer__link"
                        href={link.href}
                        rel={link.external ? 'noreferrer' : undefined}
                        target={link.external ? '_blank' : undefined}
                      >
                        {link.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </section>
            ))}
          </footer>
        </div>
      </div>
    </div>
  </body>
</html>
