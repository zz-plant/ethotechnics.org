---
import { SEO } from 'astro-seo';
import { ClientRouter } from 'astro:transitions';
import Navigation from '../components/Navigation.astro';
import { siteFooter } from '../content/site-footer';
import '../styles/global.css';
import '@fontsource-variable/plus-jakarta-sans';
import '@fontsource-variable/source-serif-4';

interface Props {
  title?: string;
  description?: string;
}

const {
  title = 'Ethotechnics — Ethical technology in practice',
  description = 'Ethotechnics.org explores how to build technology that respects human dignity through design, research, and governance.',
} = Astro.props as Props;
const canonical = Astro.site ? new URL(Astro.url.pathname, Astro.site).toString() : Astro.url.href;
const siteBase = Astro.site ? Astro.site.toString() : Astro.url.origin;
const ogImage = new URL('/favicon.svg', siteBase).toString();
const defaultTitle = 'Ethotechnics — Ethical technology in practice';
const { identity, navigation } = siteFooter;
---
<!doctype html>
<html lang="en" id="top">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <SEO
      title={title ?? defaultTitle}
      description={description}
      canonical={canonical}
      openGraph={{
        basic: {
          title: title ?? defaultTitle,
          type: 'website',
          image: ogImage,
          url: canonical,
        },
      }}
      twitter={{
        card: 'summary',
        image: ogImage,
      }}
      extend={{
        link: [{ rel: 'icon', type: 'image/svg+xml', href: '/favicon.svg' }],
      }}
    />
  </head>
  <body>
    <svg aria-hidden="true" focusable="false" style="position: absolute; width: 0; height: 0; overflow: hidden;">
      <defs>
        <filter id="paper-grain" x="0" y="0" width="100%" height="100%">
          <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" seed="4" stitchTiles="stitch" />
          <feColorMatrix type="saturate" values="0" />
          <feComponentTransfer>
            <feFuncR type="linear" slope="0.3" intercept="0.45" />
            <feFuncG type="linear" slope="0.3" intercept="0.45" />
            <feFuncB type="linear" slope="0.3" intercept="0.45" />
          </feComponentTransfer>
        </filter>
        <filter id="ink-hatch" x="0" y="0" width="100%" height="100%">
          <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" seed="8" stitchTiles="stitch" result="grain" />
          <feColorMatrix in="grain" type="saturate" values="0" result="mono" />
          <feComponentTransfer in="mono" result="ink">
            <feFuncR type="linear" slope="0.25" intercept="0.25" />
            <feFuncG type="linear" slope="0.25" intercept="0.25" />
            <feFuncB type="linear" slope="0.25" intercept="0.25" />
          </feComponentTransfer>
        </filter>
      </defs>
    </svg>
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <ClientRouter fallback="swap" />
    <Navigation />
    <main id="main-content" class="page container" tabindex="-1">
      <slot />
    </main>
    <footer class="footer container" aria-label="Site footer">
      <section class="footer__section">
        <h2 class="eyebrow footer__heading">{identity.heading}</h2>
        <div class="footer__identity">
          <a class="footer__brand" href={identity.brand.href} aria-label={identity.brand.ariaLabel}>
            <img
              src={identity.brand.logoSrc}
              alt={identity.brand.logoAlt}
              class="footer__logo"
              loading="lazy"
            />
            <span class="footer__brand-name">{identity.brand.name}</span>
          </a>
          <p class="muted">{identity.description}</p>
          <a
            class="footer__link"
            href={identity.license.href}
            rel={identity.license.external ? 'noreferrer' : undefined}
            target={identity.license.external ? '_blank' : undefined}
          >
            {identity.license.label}
          </a>
        </div>
      </section>
      {navigation.map((section) => (
        <section class="footer__section">
          <h2 class="eyebrow footer__heading">{section.heading}</h2>
          <ul class="footer__list">
            {section.links.map((link) => (
              <li>
                <a
                  class="footer__link"
                  href={link.href}
                  rel={link.external ? 'noreferrer' : undefined}
                  target={link.external ? '_blank' : undefined}
                >
                  {link.label}
                </a>
              </li>
            ))}
          </ul>
        </section>
      ))}
    </footer>
    <script>
      const main = document.getElementById('main-content');

      const focusMainAfterTransition = () => {
        requestAnimationFrame(() => {
          main?.focus();
        });
      };

      if (!document.documentElement.dataset.mainFocusListenerAttached) {
        document.documentElement.dataset.mainFocusListenerAttached = 'true';
        document.addEventListener('astro:after-swap', focusMainAfterTransition);
      }
    </script>
  </body>
</html>
