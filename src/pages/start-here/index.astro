---
import { getEntry } from "astro:content";
import CardGrid from "../../components/CardGrid.astro";
import CardItem from "../../components/CardItem.astro";
import DecisionSplit from "../../components/DecisionSplit.astro";
import PageIntro from "../../components/PageIntro.astro";
import QuickSignalPanel from "../../components/QuickSignalPanel.astro";
import ReferenceCallout from "../../components/ReferenceCallout.astro";
import SectionActions from "../../components/SectionActions.astro";
import SectionBlock from "../../components/SectionBlock.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import StudioBadge from "../../components/StudioBadge.astro";
import { instituteStudioCallout } from "../../content/callouts";
import { quickStartGuides } from "../../content/quick-start";

const startHereData = (await getEntry("startHere", "start-here"))!;
const {
  pageTitle,
  pageDescription,
  permalink,
  hero,
  anchorLinks,
  routes,
  decisionGuide,
  artifacts,
  quickStart,
  framing,
  studio,
  footerCta,
} = startHereData.data;
const recommendedCard = routes.cards.find((card) => card.recommendedTag);
const recommendedDetails = recommendedCard
  ? [
      { text: recommendedCard.recommendedNote, className: "muted" },
      { text: recommendedCard.bestFor, className: "muted small" },
      { text: recommendedCard.time, className: "muted small" },
      { text: recommendedCard.description, className: "muted small" },
    ].filter((detail) => detail.text)
  : [];
const { cspNonce } = Astro.locals;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <PageIntro
    eyebrow={hero.eyebrow}
    title={hero.heading}
    description={hero.description}
    permalink={permalink}
    anchorLinks={anchorLinks}
    panelCopy={hero.panel}
  />
  {
    recommendedCard && (
      <div class="callout">
        <p class="eyebrow">Recommended first step</p>
        <h3>{recommendedCard.title}</h3>
        {recommendedDetails.map((detail) => (
          <p class={detail.className}>{detail.text}</p>
        ))}
        <SectionActions>
          {hero.actions.map((action) => (
            <a
              class={`button ${action.variant}`}
              href={action.href}
              aria-label={action.ariaLabel ?? action.label}
            >
              {action.label}
            </a>
          ))}
        </SectionActions>
      </div>
    )
  }
  <SectionActions>
    <StudioBadge />
  </SectionActions>
  <QuickSignalPanel
    eyebrow="Fast orientation"
    title="Navigate the fastest next step."
    summary={hero.quickSummary}
    bullets={hero.deliverables}
    note={hero.quickNote}
  />

  <SectionBlock
    id="framing"
    eyebrow={framing.eyebrow}
    title={framing.title}
    description={framing.description}
  >
    <DecisionSplit
      leftTitle="This page is"
      leftItems={framing.isList}
      rightTitle="This page is not"
      rightItems={framing.isNotList}
      note="Every link is a permalink that stays updated as guidance changes."
    />
  </SectionBlock>

  <SectionBlock
    id="routes"
    eyebrow={routes.eyebrow}
    title={routes.title}
    description={routes.description}
    className="section--banded"
  >
    <CardGrid className="grid--two">
      {
        routes.cards.map((card) => (
          <CardItem
            title={card.title}
            description={card.description}
            descriptionTone="default"
            tags={
              card.recommendedTag
                ? [card.recommendedTag, ...card.tags]
                : card.tags
            }
          >
            {card.recommendedNote && (
              <p class="muted small">{card.recommendedNote}</p>
            )}
            <p class="muted">{card.bestFor}</p>
            <p class="muted small">{card.time}</p>
            <div slot="footer" class="card__footer">
              <a
                class="button ghost button--compact"
                href={card.href}
                aria-label={`Go to ${card.title}`}
              >
                Visit {card.title.toLowerCase()}
              </a>
            </div>
          </CardItem>
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="quick-start"
    eyebrow={quickStart.eyebrow}
    title={quickStart.title}
    description={quickStart.description}
  >
    <CardGrid className="grid--two">
      {
        quickStartGuides.map((guide) => (
          <CardItem
            title={guide.title}
            description={guide.summary}
            descriptionTone="default"
          >
            <ul class="muted">
              {guide.focusAreas.map((area) => (
                <li>{area}</li>
              ))}
            </ul>
            <div slot="footer" class="card__footer">
              <a
                class="button ghost button--compact"
                href={`/quick-start/${guide.slug}`}
              >
                Open {guide.title.toLowerCase()} guide
              </a>
            </div>
          </CardItem>
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="artifacts"
    eyebrow={artifacts.eyebrow}
    title={artifacts.title}
    description={artifacts.description}
    variant="alt"
  >
    <CardGrid className="grid--two">
      {
        artifacts.previews.map((preview) => (
          <CardItem
            title={preview.title}
            description={preview.description}
            descriptionTone="default"
          >
            <p class="muted">{preview.note}</p>
            <div slot="footer" class="card__footer">
              <a
                class="button primary button--compact"
                href={preview.href}
                aria-label={preview.label}
              >
                {preview.label}
              </a>
            </div>
          </CardItem>
        ))
      }
    </CardGrid>
    <SectionActions
      className="artifacts__actions"
      ariaLabel="Artifact bundle actions"
    >
      <button
        class="button ghost button--compact"
        type="button"
        data-artifact-download
      >
        Download artifact list
      </button>
      <button
        class="button ghost button--compact"
        type="button"
        data-artifact-copy
      >
        Copy artifact list
      </button>
    </SectionActions>
    <p class="muted small" data-artifact-status>
      Generate a shareable list of required artifacts for your team.
    </p>
  </SectionBlock>

  <SectionBlock
    id="decision-guide"
    eyebrow={decisionGuide.eyebrow}
    title={decisionGuide.title}
    description={decisionGuide.description}
    className="section--banded"
  >
    <CardGrid className="grid--three">
      {
        decisionGuide.prompts.map((prompt) => (
          <CardItem
            title={prompt.question}
            description={prompt.answer}
            descriptionTone="default"
          >
            <div slot="footer" class="card__footer">
              <a
                class="button ghost button--compact"
                href={prompt.href}
                rel={
                  prompt.href.startsWith("http")
                    ? "noopener noreferrer"
                    : undefined
                }
                target={prompt.href.startsWith("http") ? "_blank" : undefined}
              >
                {prompt.label}
              </a>
            </div>
          </CardItem>
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="studio"
    eyebrow={studio.eyebrow}
    title={studio.title}
    description={studio.description}
    className="section--banded"
  >
    <CardGrid>
      <CardItem descriptionTone="default">
        <ReferenceCallout
          title={instituteStudioCallout.title}
          summary={instituteStudioCallout.summary}
          href={instituteStudioCallout.href}
          linkLabel={instituteStudioCallout.linkLabel}
          ariaLabel={instituteStudioCallout.ariaLabel}
        />
        <ul class="muted">
          {studio.bullets.map((bullet) => <li>{bullet}</li>)}
        </ul>
        <div class="card__footer">
          <a
            class="button ghost"
            href={studio.ctaHref}
            aria-label={studio.ctaAriaLabel}
            rel="noopener noreferrer"
            target="_blank"
          >
            {studio.ctaLabel}
          </a>
        </div>
      </CardItem>
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="cta"
    eyebrow={footerCta.eyebrow}
    title={footerCta.title}
    description={footerCta.description}
    variant="alt"
  >
    <SectionActions>
      <a class="button primary" href={footerCta.primaryHref}>
        {footerCta.primaryLabel}
      </a>
      <a class="button ghost" href={footerCta.secondaryHref}>
        {footerCta.secondaryLabel}
      </a>
    </SectionActions>
  </SectionBlock>
  <script
    type="application/json"
    id="artifact-data"
    is:inline
    set:html={JSON.stringify({ artifacts: artifacts.previews })}
  />
  <script is:inline nonce={cspNonce}>
    const artifactData = document.querySelector("#artifact-data");
    const parsedArtifacts = artifactData
      ? JSON.parse(artifactData.textContent || "{}")
      : {};
    const artifactsList = parsedArtifacts.artifacts ?? [];
    const downloadButton = document.querySelector("[data-artifact-download]");
    const copyButton = document.querySelector("[data-artifact-copy]");
    const status = document.querySelector("[data-artifact-status]");

    const buildArtifactMarkdown = () => {
      const lines = [
        "# Required artifacts",
        "Generated from ethotechnics.org/start-here",
        "",
      ];
      artifactsList.forEach((artifact) => {
        lines.push(`- ${artifact.title}: ${artifact.href}`);
      });
      return lines.join("\\n");
    };

    const triggerDownload = (content) => {
      const blob = new Blob([content], { type: "text/markdown" });
      const url = URL.createObjectURL(blob);
      const anchor = document.createElement("a");
      anchor.href = url;
      anchor.download = "ethotechnics-artifacts.md";
      anchor.click();
      URL.revokeObjectURL(url);
    };

    downloadButton?.addEventListener("click", () => {
      triggerDownload(buildArtifactMarkdown());
      if (status) {
        status.textContent = "Downloaded the artifact list as markdown.";
      }
    });

    copyButton?.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(buildArtifactMarkdown());
        if (status) {
          status.textContent = "Copied the artifact list to your clipboard.";
        }
      } catch {
        if (status) {
          status.textContent =
            "Copy failed. Select the text manually after download.";
        }
      }
    });
  </script>
</BaseLayout>
