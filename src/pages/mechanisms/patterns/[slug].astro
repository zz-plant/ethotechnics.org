---
import { getEntry } from "astro:content";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import CardGrid from "../../../components/CardGrid.astro";
import CardItem from "../../../components/CardItem.astro";
import CitationBlock from "../../../components/CitationBlock.astro";
import PageIntro from "../../../components/PageIntro.astro";
import ScholarlyMeta from "../../../components/ScholarlyMeta.astro";
import SectionBlock from "../../../components/SectionBlock.astro";
import type { DiagnosticTool } from "../../../content/diagnostics";
import { diagnosticsContent } from "../../../content/diagnostics";
import { getGlossaryLabel, glossaryEntryPermalink } from "../../../utils/glossary";

const { slug } = Astro.params;
const libraryEntry = (await getEntry("library", "library"))!;
const pattern = libraryEntry.data.patterns.entries.find(
  (entry) => entry.slug === slug
);
const libraryContent = libraryEntry.data;
const publication = libraryContent.publication;

if (!pattern) {
  return Astro.response(
    new Response("Mechanism not found", {
      status: 404,
    })
  );
}

const filterLabels = Object.fromEntries(
  libraryContent.patterns.filters.map((filter) => [filter.slug, filter.label])
);
const validatorLinks = pattern.diagnostics
  .map((diagnosticSlug) =>
    diagnosticsContent.tools.find((tool) => tool.slug === diagnosticSlug)
  )
  .filter((tool): tool is DiagnosticTool => Boolean(tool));
const glossaryAnchors = pattern.glossaryRefs.map((slug) => ({
  slug,
  label: getGlossaryLabel(slug),
  href: glossaryEntryPermalink(slug),
}));
const pageTitle = `${pattern.title} â€” Mechanism specification`;
const pageDescription = pattern.summary;
const permalink = `/mechanisms/patterns/${pattern.slug}`;
const panelDescription = `Tagged for ${pattern.filters
  .map((filter) => filterLabels[filter] ?? filter)
  .join(", ")} with validator handshakes. Includes ${pattern.steps.length} steps, ${
  pattern.artifacts.length
} reusable assets, and ${pattern.policyRequirement ? 4 : 0} snippet blocks.`;
const hasAntiPatterns = (pattern.antiPatterns?.length ?? 0) > 0;
const anchorLinks = [
  ...(glossaryAnchors.length
    ? [{ href: "#glossary", label: "Glossary anchors" }]
    : []),
  { href: "#steps", label: "Steps" },
  { href: "#assets", label: "Assets" },
  { href: "#reuse-snippets", label: "Reuse-ready snippets" },
  { href: "#example", label: "Example usage" },
  ...(hasAntiPatterns
    ? [{ href: "#anti-patterns", label: "Anti-patterns" }]
    : []),
  { href: "#validators", label: "Validators" },
];
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <PageIntro
    eyebrow="Specification sheet"
    title={pattern.title}
    description={pageDescription}
    permalink={permalink}
    anchorLinks={anchorLinks}
    panelCopy={{
      eyebrow: "Where it fits",
      title: "Filters and handoffs",
      description: panelDescription,
    }}
  />
  <ScholarlyMeta publication={publication} permalink={permalink} />
  <CitationBlock
    title={pattern.title}
    permalink={permalink}
    publication={publication}
    citationKey={`mechanism_${pattern.slug}`}
  />

  {
    glossaryAnchors.length > 0 && (
      <SectionBlock
        id="glossary"
        eyebrow="Glossary anchors"
        title="Link back to the definitions."
        description="Jump to the glossary terms that frame this mechanism."
        variant="alt"
      >
        <ul class="pill-list pattern-detail__glossary-links">
          {glossaryAnchors.map((anchor) => (
            <li>
              <a class="pill-list__button" href={anchor.href}>
                {anchor.label}
              </a>
            </li>
          ))}
        </ul>
      </SectionBlock>
    )
  }

  <SectionBlock
    id="steps"
    eyebrow="Steps"
    title="Put the mechanism in motion."
    description="Start with the field cues, then use the assets to keep the work legible."
  >
    <div class="pattern-detail__step-summary">
      <p class="muted">
        {pattern.steps.length} steps with checklist-ready owners, plus linked assets for
        handoffs.
      </p>
    </div>
    <div class="pattern-detail__checklist-progress" hidden>
      <p class="muted small">
        <span id="checklist-count">0</span> of {pattern.steps.length} steps complete
      </p>
      <div class="progress-bar">
        <div class="progress-bar__fill" id="checklist-bar"></div>
      </div>
    </div>
    <ol class="pattern-detail__steps">
      {
        pattern.steps.map((step, index) => (
          <li>
            <label class="card card--emphasis pattern-detail__step-card is-interactive">
              <div class="card__glow" aria-hidden="true" />
              <div class="pattern-detail__step-header">
                <p class="muted">Step {index + 1}</p>
                <input
                  type="checkbox"
                  class="pattern-detail__step-checkbox"
                  data-step-index={index}
                />
              </div>
              <h3>{step}</h3>
            </label>
          </li>
        ))
      }
    </ol>
  </SectionBlock>

  <SectionBlock
    id="assets"
    eyebrow="Assets"
    title="Keep outputs reusable."
    description="Link or copy these assets into design docs, runbooks, and briefs so the mechanism travels with the work."
    variant="alt"
  >
    <CardGrid className="grid--two">
      {
        pattern.artifacts.map((artifact) => (
          <CardItem title={artifact.name} description={artifact.purpose} />
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="reuse-snippets"
    eyebrow="Reuse-ready snippets"
    title="Copy policy, audit, and incident language."
    description="Use these snippets in requirements, audits, and postmortems with the mechanism permalink."
  >
    <div class="grid grid--two">
      <div class="panel pattern-detail__snippet" data-snippet="policy">
        <p class="eyebrow">Policy requirement</p>
        <pre class="code-block">{pattern.policyRequirement}</pre>
      </div>
      <div class="panel pattern-detail__snippet" data-snippet="product">
        <p class="eyebrow">Product requirement</p>
        <pre class="code-block">{pattern.productRequirement}</pre>
      </div>
      <div class="panel pattern-detail__snippet" data-snippet="audit">
        <p class="eyebrow">Audit evidence checklist</p>
        <pre class="code-block">{pattern.auditEvidenceChecklist}</pre>
      </div>
      <div class="panel pattern-detail__snippet" data-snippet="postmortem">
        <p class="eyebrow">Postmortem trigger</p>
        <pre class="code-block">{pattern.postmortemTrigger}</pre>
      </div>
    </div>
  </SectionBlock>

  <SectionBlock
    id="example"
    eyebrow="Example usage"
    title={pattern.example.title}
    description="A concrete scenario to help teams see how the pieces fit together."
  >
    <div class="pattern-detail__example">
      <div class="card card--emphasis">
        <div class="card__glow" aria-hidden="true"></div>
        <p class="muted">How it plays out</p>
        <p class="pattern-detail__example-copy">
          {pattern.example.description}
        </p>
      </div>
    </div>
  </SectionBlock>

  {
    hasAntiPatterns && (
      <SectionBlock
        id="anti-patterns"
        eyebrow="Anti-patterns"
        title="Common failure cases and counterfactuals"
        description="Use these to avoid superficial compliance and clarify what success requires."
        variant="alt"
      >
        <CardGrid className="grid--two">
          {pattern.antiPatterns?.map((antiPattern) => (
            <CardItem title={antiPattern.title} descriptionTone="default">
              <p class="muted">{antiPattern.failure}</p>
              <p class="muted small">
                Counterfactual: {antiPattern.counterfactual}
              </p>
              <p class="muted small">
                False-positive warning: {antiPattern.warning}
              </p>
            </CardItem>
          ))}
        </CardGrid>
      </SectionBlock>
    )
  }

  <SectionBlock
    id="validators"
    eyebrow="Validators"
    title="Pair validators with this mechanism."
    description="Use these tools to size risk and keep the stewardship path visible."
    variant="alt"
  >
    <div class="pattern-detail__diagnostics">
      <ul class="pill-list">
        {
          pattern.filters.map((filter) => (
            <li>
              <a class="pill-list__button" href={`/mechanisms#${filter}`}>
                {filterLabels[filter] ?? filter}
              </a>
            </li>
          ))
        }
      </ul>

      <div class="pattern-detail__diagnostic-list">
        {
          validatorLinks.map((tool) => (
            <article
              class="card pattern-detail__diagnostic-card"
              id={tool.slug}
            >
              <div class="card__glow" aria-hidden="true" />
              <div class="pattern-detail__diagnostic-header">
                <div>
                  <p class="muted">Validator</p>
                  <h3>{tool.title}</h3>
                </div>
                <button
                  class="copy-button"
                  type="button"
                  data-copy-link={`/validators/${tool.slug}`}
                  aria-label={`Copy link to ${tool.title}`}
                >
                  Copy link
                </button>
              </div>
              <p class="muted">{tool.description}</p>
            </article>
          ))
        }
      </div>
    </div>
  </SectionBlock>
</BaseLayout>

<script>
  const copyButtons = Array.from(document.querySelectorAll("[data-copy-link]"));

  copyButtons.forEach((button) => {
    if (!(button instanceof HTMLButtonElement)) {
      return;
    }

    const target = button.getAttribute("data-copy-link");
    const defaultLabel = button.textContent?.trim() ?? "Copy link";

    if (!target) {
      return;
    }

    button.addEventListener("click", async () => {
      const link = new URL(target, window.location.origin).toString();

      try {
        await navigator.clipboard.writeText(link);
        button.textContent = "Copied";
        window.setTimeout(() => {
          button.textContent = defaultLabel;
        }, 1500);
      } catch (error) {
        console.error("Copy failed", error);
        button.textContent = "Copy failed";
        window.setTimeout(() => {
          button.textContent = defaultLabel;
        }, 1500);
      }
    });
  });

  // Checklist logic
  const checkboxes = document.querySelectorAll(
    ".pattern-detail__step-checkbox"
  );
  const countSpan = document.getElementById("checklist-count");
  const progressBar = document.getElementById("checklist-bar");
  const progressContainer = document.querySelector(
    ".pattern-detail__checklist-progress"
  );

  if (checkboxes.length > 0 && progressContainer) {
    progressContainer.removeAttribute("hidden");

    const updateProgress = () => {
      const checked = Array.from(checkboxes).filter(
        (cb) => (cb as HTMLInputElement).checked
      ).length;
      if (countSpan) countSpan.textContent = checked.toString();
      if (progressBar)
        progressBar.style.width = `${(checked / checkboxes.length) * 100}%`;
    };

    checkboxes.forEach((cb) => {
      cb.addEventListener("change", updateProgress);
    });
  }
</script>

<style is:global>
  .pattern-detail__step-card.is-interactive {
    cursor: pointer;
    transition:
      transform 0.2s ease,
      border-color 0.2s ease;
  }

  .pattern-detail__step-card.is-interactive:hover {
    transform: translateY(-2px);
    border-color: var(--color-primary, #007bff);
  }

  .pattern-detail__step-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .pattern-detail__step-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
  }

  .pattern-detail__checklist-progress {
    margin-bottom: 2rem;
    background: var(--color-surface-dim, #f8f9fa);
    padding: 1rem;
    border-radius: 8px;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--color-border, #e9ecef);
    border-radius: 4px;
    margin-top: 0.5rem;
    overflow: hidden;
  }

  .progress-bar__fill {
    height: 100%;
    background: var(--color-primary, #007bff);
    width: 0%;
    transition: width 0.3s ease;
  }
</style>
