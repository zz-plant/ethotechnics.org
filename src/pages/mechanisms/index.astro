---
import { getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import PageIntro from "../../components/PageIntro.astro";
import CardGrid from "../../components/CardGrid.astro";
import CardItem from "../../components/CardItem.astro";
import CitationBlock from "../../components/CitationBlock.astro";
import PatternFilter from "../../components/PatternFilter.astro";
import ScholarlyMeta from "../../components/ScholarlyMeta.astro";
import SectionBlock from "../../components/SectionBlock.astro";
import { diagnosticsContent } from "../../content/diagnostics";
import { glossaryEntryPermalink } from "../../utils/glossary";

const libraryEntry = (await getEntry("library", "library"))!;
const {
  pageTitle,
  pageDescription,
  permalink,
  primer,
  patterns,
  syllabus,
  quickStart,
  recommended,
  rolePathways,
  publication,
} = libraryEntry.data;
const { cspNonce } = Astro.locals;
const diagnosticTitles = Object.fromEntries(
  diagnosticsContent.tools.map((tool) => [tool.slug, tool.title]),
);
const glossaryEntry = (await getEntry("glossary", "glossary"))!;
const glossaryContent = glossaryEntry.data;
const glossaryHref = (slug: string) => glossaryEntryPermalink(slug);
type GlossaryStarterTerm = (typeof glossaryContent.starterTerms)[number];
const quickFilters = patterns.filters.slice(0, 6);
const pageUrl = Astro.site
  ? new URL(permalink, Astro.site).toString()
  : permalink;
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "@id": pageUrl,
  name: pageTitle,
  description: pageDescription,
  url: pageUrl,
  hasPart: patterns.entries.map((pattern) => ({
    "@type": "CreativeWork",
    name: pattern.title,
    description: pattern.summary,
    url: Astro.site
      ? new URL(`/mechanisms/patterns/${pattern.slug}`, Astro.site).toString()
      : `/mechanisms/patterns/${pattern.slug}`,
    keywords: pattern.filters,
  })),
};
const structuredDataJson = JSON.stringify(structuredData, null, 2);
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <PageIntro
    eyebrow="Mechanisms"
    title="Mechanisms"
    description={pageDescription}
    permalink={permalink}
    anchorLinks={[
      { href: "#quick-filters", label: "Quick filters" },
      { href: "#themes", label: "Browse by theme" },
      { href: "#role-pathways", label: "Role-based pathways" },
      { href: "#primer", label: "Primer" },
      { href: "#safety-object-model", label: "Agent safety object model" },
      { href: "#glossary", label: "Glossary" },
      { href: "#mechanisms", label: "Mechanism specs" },
      { href: "#syllabus", label: "Syllabus" },
      { href: "#referenced-by", label: "Referenced by" },
    ]}
    panelCopy={{
      eyebrow: "How to use this shelf",
      title: "Structured, linkable specifications",
      description:
        "Stable permalinks and filters keep standards, mechanisms, and validators aligned.",
    }}
  >
    <Fragment slot="actions">
      <a class="button primary" href="#quick-filters">
        Browse quick filters
      </a>
      <a class="button ghost" href="#primer">
        Read the primer
      </a>
    </Fragment>
  </PageIntro>
  <ScholarlyMeta publication={publication} permalink={permalink} />
  <CitationBlock
    title={pageTitle}
    permalink={permalink}
    publication={publication}
    variant="compact"
  />
  <div class="callout">
    <h3>Cross-link to rights and validators</h3>
    <p class="muted">
      Map each mechanism to the rights it enforces and the validators that confirm coverage.
    </p>
    <div class="library__role-buttons">
      <a
        class="button primary library__role-button"
        href="/standards/std-01-rights-matrix"
      >
        Open the rights matrix
      </a>
      <a class="button primary library__role-button" href="/validators">
        Run validators
      </a>
      <a
        class="button primary library__role-button"
        href="/standards/std-01-temporal-rights"
      >
        Review the rights
      </a>
    </div>
  </div>
  <SectionBlock
    id="quick-filters"
    eyebrow="Quick filters"
    title="Jump into the most-used mechanism lenses."
    description="Start with a targeted filter before exploring the full catalog."
    variant="alt"
  >
    <ul class="pill-list pill-list--wrap">
      {quickFilters.map((filter) => (
        <li>
          <a class="pill-list__button" href={`/mechanisms?filter=${filter.slug}`}>
            {filter.label}
          </a>
        </li>
      ))}
    </ul>
  </SectionBlock>
  <SectionBlock
    id="role-pathways"
    eyebrow="Role-based pathways"
    title={rolePathways.title}
    description={rolePathways.description}
  >
    <div class="library__role-buttons">
      {
        rolePathways.roles.map((role) => (
          <a class="button primary library__role-button" href={`#${role.id}`}>
            {role.label}
          </a>
        ))
      }
    </div>
    <div class="library__role-lists">
      {
        rolePathways.roles.map((role) => (
          <div class="library__role-list" id={role.id}>
            <h3>{role.label}</h3>
            <p class="muted">{role.summary}</p>
            <CardGrid>
              {role.items.map((item) => (
                <CardItem title={item.title} description={item.description}>
                  <a slot="footer" class="muted" href={item.href}>
                    Open reading
                  </a>
                </CardItem>
              ))}
            </CardGrid>
          </div>
        ))
      }
    </div>
  </SectionBlock>
  <div class="callout">
    <h3>Quick start</h3>
    <ul class="muted">
      {quickStart.map((item) => <li>{item}</li>)}
    </ul>
  </div>
  <div class="callout library__recommended">
    <h3>{recommended.title}</h3>
    <p class="muted">{recommended.description}</p>
    <ul class="library__recommended-list">
      {
        recommended.items.map((item) => (
          <li>
            <a href={item.href}>{item.title}</a>
            <p class="muted small">{item.description}</p>
          </li>
        ))
      }
    </ul>
  </div>

  <SectionBlock
    id="safety-object-model"
    eyebrow="Agent Safety Object Model"
    title="Link mechanisms to a machine-readable governance profile"
    description="Publish the spec so mechanisms map to enforceable controls."
    variant="alt"
  >
    <p class="muted">
      The
      {" "}
      <a href="/agents/spec">Agent Safety Object Model</a>
      {" "}
      ties action classes, receipts, and kill-switch authority to specific mechanisms.
    </p>
    <ul class="muted">
      <li>Map MEC-01, MEC-05, and MEC-06 into the model.</li>
      <li>Declare clocks and approvals per action class.</li>
      <li>Attach evidence packs to validate compliance.</li>
    </ul>
  </SectionBlock>

  <SectionBlock
    id="themes"
    eyebrow="Browse by theme"
    title="Jump directly to the work you need."
    description="Use tags to pre-filter the mechanisms catalog."
  >
    <div class="tag-rail">
      <ul class="pill-list pill-list--wrap">
        {
          patterns.filters.map((filter) => (
            <li class="pill-list__item tag-rail__item">
              <a
                class="pill-list__button"
                href={`#${filter.slug}`}
                aria-label={`Jump to ${filter.label} materials`}
              >
                {filter.label}
              </a>
              <p class="muted small tag-rail__description">
                {filter.description}
              </p>
            </li>
          ))
        }
      </ul>
    </div>
  </SectionBlock>

  <SectionBlock
    id="primer"
    eyebrow="Primer"
    title="Start here before diving into mechanisms."
    description="Short overviews for onboarding and briefings."
    variant="alt"
  >
    <CardGrid>
      {
        primer.map((entry) => (
          <CardItem
            title={entry.title}
            description={entry.summary}
            tags={entry.takeaways}
          />
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="glossary"
    eyebrow="Glossary"
    title="Stable terms with per-entry permalinks."
    description="Use these anchors across Field Notes, Research, and Diagnostics."
  >
    <CardGrid>
      {
        glossaryContent.starterTerms.map((term: GlossaryStarterTerm) => (
          <CardItem
            id={term.id}
            eyebrow="Glossary term"
            title={term.label}
            description={term.description}
          >
            <a slot="footer" class="muted" href={glossaryHref(term.id)}>
              Permalink to {term.label}
            </a>
          </CardItem>
        ))
      }
    </CardGrid>
    <p class="muted glossary__cta">
      Full glossary: <a href={glossaryContent.permalink}>/glossary</a>
    </p>
  </SectionBlock>

  <SectionBlock
    id="mechanisms"
    eyebrow="Mechanisms"
    title="Governance, friction, and policy mechanisms with validator links."
    description="Filters route work quickly and keep validators in reach."
    variant="alt"
  >
    <div class="pattern-filter__anchors" aria-hidden="true">
      <span class="pattern-filter__anchor" id="mechanisms"></span>
      {
        patterns.filters.map((filter) => (
          <span class="pattern-filter__anchor" id={filter.slug} />
        ))
      }
    </div>
    <PatternFilter
      filters={patterns.filters}
      entries={patterns.entries}
      diagnosticTitles={diagnosticTitles}
    />
  </SectionBlock>

  <SectionBlock
    id="syllabus"
    eyebrow="Syllabus"
    title="Guided path for teams adopting the mechanisms."
    description={syllabus.overview}
  >
    <CardGrid>
      {
        syllabus.modules.map((module) => (
          <CardItem
            meta={module.duration}
            title={module.title}
            tags={module.topics}
          >
            <p class="muted">Outcome: {module.outcome}</p>
          </CardItem>
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="referenced-by"
    eyebrow="Referenced by"
    title="How mechanisms connect to the rest of the system"
    description="Cross-links keep mechanisms, standards, and audits aligned."
    variant="alt"
  >
    <div class="grid grid--three">
      <div class="panel">
        <p class="eyebrow">Used in examples</p>
        <ul class="muted">
          <li>
            <a href="/examples/automated-account-lock">Automated account lock</a
            >
          </li>
          <li>
            <a href="/examples/content-moderation-takedown"
              >Content moderation takedown</a
            >
          </li>
          <li>
            <a href="/examples/fraud-hold-delayed-notice"
              >Fraud hold with delayed notice</a
            >
          </li>
        </ul>
      </div>
      <div class="panel">
        <p class="eyebrow">Required by bindings</p>
        <ul class="muted">
          <li>
            <a href="/bindings#release-gates">Release gate checklist</a>
          </li>
          <li>
            <a href="/bindings#incidents">Incident triggers</a>
          </li>
          <li>
            <a href="/bindings#runbooks">Runbook snippets</a>
          </li>
        </ul>
      </div>
      <div class="panel">
        <p class="eyebrow">Verified by evidence packs</p>
        <ul class="muted">
          <li>
            <a href="/evidence-packs/std-01">STD-01 Evidence Pack</a>
          </li>
          <li>
            <a href="/evidence-packs/std-02">STD-02 Evidence Pack</a>
          </li>
          <li>
            <a href="/validators">Validators (VAL-01â€“VAL-03)</a>
          </li>
        </ul>
      </div>
    </div>
    <p class="muted">
      Search IDs: MEC-01, MEC-03, MEC-05, MEC-06, STD-01.1.1, STD-02.2.1,
      VAL-01, VAL-02, VAL-03.
    </p>
  </SectionBlock>
  <script
    type="application/ld+json"
    nonce={cspNonce}
    set:html={structuredDataJson}
    is:inline
  />
</BaseLayout>
