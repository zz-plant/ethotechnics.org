---
import { Icon } from 'astro-icon/components';
import BaseLayout from '../layouts/BaseLayout.astro';
import { homeContent } from '../content/home';
import Illustration from '../components/Illustration.astro';
import InstituteStudioComparison from '../components/InstituteStudioComparison.astro';

const { pageTitle, pageDescription, hero, about, features, highlight, cta } = homeContent;

const buildSparklinePath = (points?: number[], width = 120, height = 36) => {
  if (!points || points.length === 0) return '';

  const max = Math.max(...points);
  const min = Math.min(...points);
  const range = max - min || 1;
  const step = points.length > 1 ? width / (points.length - 1) : width;

  return points
    .map((point, index) => {
      const x = index * step;
      const y = height - ((point - min) / range) * height;
      const prefix = index === 0 ? 'M' : 'L';

      return `${prefix}${x.toFixed(2)} ${y.toFixed(2)}`;
    })
    .join(' ');
};
---
<BaseLayout title={pageTitle} description={pageDescription}>
  <section class="hero">
    <div class="hero__canvas" aria-hidden="true">
      <span class="beam beam--one" />
      <span class="beam beam--two" />
      <span class="beam beam--three" />
      <span class="gridlines" />
    </div>
    <div class="hero__layout">
      <div class="hero__content">
        <p class="eyebrow">{hero.eyebrow}</p>
        <h1>{hero.heading}</h1>
        <p class="muted">{hero.subheadline}</p>
        <p class="lede">{hero.lede}</p>
        <p class="muted" set:html={hero.map}></p>
        <div class="hero__tags" aria-label="Focus areas">
          {hero.metrics.map((metric) => (
            <span class="pill pill--ghost">{metric.value}</span>
          ))}
        </div>
        <div class="actions">
          {hero.actions.map((action) => (
            <a
              class={`button ${action.variant}`}
              href={action.href}
              rel={action.href.startsWith('http') ? 'noreferrer' : undefined}
            >
              {action.icon ? <Icon class="button__icon" name={action.icon} aria-hidden="true" /> : null}
              <span>{action.label}</span>
            </a>
          ))}
        </div>
      </div>
      <figure class="hero__media">
        <div class="hero__media-frame">
          <img src={hero.media.src} alt={hero.media.alt} loading="lazy" decoding="async" />
        </div>
        {hero.media.caption ? <figcaption class="muted">{hero.media.caption}</figcaption> : null}
      </figure>
      <div class="hero__panel">
        <div class="panel panel--glass">
          <p class="muted">{hero.panel.title}</p>
          <h3>{hero.panel.description}</h3>
          <ul class="pill-list pill-list--wrap">
            {hero.panel.pills.map((pill) => (
              <li>{pill}</li>
            ))}
          </ul>
        </div>
        <div class="hero__meta" aria-label="Proof points">
          {hero.metrics.map((metric) => (
            <article class="stat-card">
              <div class="stat-card__header">
                {metric.icon ? (
                  <span class="stat-card__icon" aria-hidden="true">
                    <Icon name={metric.icon} />
                  </span>
                ) : null}
                <p class="muted">{metric.label}</p>
              </div>
              <p class="metric">{metric.value}</p>
              {metric.trend?.length ? (
                <div class="stat-card__trend">
                  <svg
                    class="stat-card__sparkline"
                    viewBox="0 0 120 36"
                    preserveAspectRatio="none"
                    role="img"
                    aria-label={metric.trendLabel ?? `${metric.label} trend`}
                  >
                    <path d={buildSparklinePath(metric.trend)} />
                  </svg>
                </div>
              ) : null}
            </article>
          ))}
        </div>
      </div>
    </div>
  </section>

  <InstituteStudioComparison />

  <section class="info-strip" aria-label="How this works">
    <div class="info-strip__lead">
      <p class="eyebrow">How this works</p>
      <p class="muted">A living charter keeps the Institute accountable, and our work stays remixable.</p>
    </div>
    <div class="info-strip__actions" aria-label="Reference links">
      <a class="info-strip__badge" href="/institute">
        <span class="info-strip__icon" aria-hidden="true">
          <Icon name="lucide:shield-check" />
        </span>
        <span class="info-strip__copy">
          <span class="info-strip__label">Charter</span>
          <span class="info-strip__title">Ethotechnics Institute</span>
        </span>
      </a>
      <a
        class="info-strip__badge"
        href="https://creativecommons.org/licenses/by/4.0/"
        rel="noreferrer"
        target="_blank"
      >
        <span class="info-strip__icon" aria-hidden="true">
          <Icon name="lucide:creative-commons" />
        </span>
        <span class="info-strip__copy">
          <span class="info-strip__label">License</span>
          <span class="info-strip__title">CC BY 4.0 International</span>
        </span>
      </a>
    </div>
  </section>

  <section id="about" class="section">
    <div class="section__header">
      <p class="eyebrow">{about.eyebrow}</p>
      <h2>{about.heading}</h2>
      <p class="muted">{about.body}</p>
    </div>
    <div class="bento">
      {about.features.map((feature) => (
        <article class="tile">
          <div class="icon" aria-hidden="true">
            {feature.icon ? <Icon name={feature.icon} /> : null}
          </div>
          <div class="tile__body">
            <h3>{feature.title}</h3>
            <p>{feature.description}</p>
          </div>
        </article>
      ))}
    </div>
  </section>

  <section id="features" class="section section--alt">
    <div class="section__header">
      <p class="eyebrow">{features.eyebrow}</p>
      <h2>{features.heading}</h2>
      <p class="muted">{features.body}</p>
    </div>
    <div class="features__layout grid grid--two">
      <Illustration
        src="/assets/focus-illustration.svg"
        alt="Diagram linking responsible delivery, research, and governance focus areas."
        caption="A focal map of how the Institute keeps product delivery accountable."
        className="features__illustration"
      />
      <div class="grid grid--two features__grid">
        {features.cards.map((feature) => (
          <article
            class={`card${feature.emphasis ? ' card--emphasis' : ''}`}
            aria-label={feature.emphasis ? 'Navigation feature highlight' : undefined}
          >
            <div class="card__glow" aria-hidden="true" />
            <h3>{feature.title}</h3>
            <p>{feature.description}</p>
            {feature.pills ? (
              <ul class="pill-list">
                {feature.pills.map((pill) => (
                  <li>{pill}</li>
                ))}
              </ul>
            ) : null}
          </article>
        ))}
      </div>
    </div>
  </section>

  <section id="insights" class="section highlight">
    <div class="section__header">
      <p class="eyebrow">{highlight.eyebrow}</p>
      <h2>{highlight.heading}</h2>
      <p class="muted">{highlight.body}</p>
    </div>
    <div class="highlight__content">
      <div class="callout">
        <p class="muted">Field note</p>
        <h3>{highlight.note.title}</h3>
        <p>{highlight.note.description}</p>
        <ul>
          {highlight.note.actions.map((action) => (
            <li>{action}</li>
          ))}
        </ul>
        <a class="button ghost" href={highlight.note.link.href}>
          {highlight.note.link.label}
        </a>
      </div>
      <div class="highlight__meta">
        <p class="muted">Built for teams</p>
        <ul class="pill-list pill-list--wrap">
          {highlight.pills.map((pill) => (
            <li>{pill}</li>
          ))}
        </ul>
      </div>
    </div>
  </section>

  <section id="cta" class="cta">
    <div>
      <p class="eyebrow">{cta.eyebrow}</p>
      <h2>{cta.heading}</h2>
      <p class="muted">{cta.body}</p>
    </div>
    <div class="actions">
      {cta.actions.map((action) => (
        <a
          class={`button ${action.variant}`}
          href={action.href}
          rel={action.href.startsWith('http') ? 'noreferrer' : undefined}
        >
          {action.icon ? <Icon class="button__icon" name={action.icon} aria-hidden="true" /> : null}
          <span>{action.label}</span>
        </a>
      ))}
    </div>
  </section>
</BaseLayout>
