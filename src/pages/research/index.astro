---
import PageIntro from "../../components/PageIntro.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import CardGrid from "../../components/CardGrid.astro";
import CardItem from "../../components/CardItem.astro";
import CitationBlock from "../../components/CitationBlock.astro";
import ScholarlyMeta from "../../components/ScholarlyMeta.astro";
import SectionBlock from "../../components/SectionBlock.astro";
import SummaryCallout from "../../components/SummaryCallout.astro";
import {
  getGlossaryDefinition,
  getGlossaryLabel,
  glossaryEntryPermalink,
} from "../../utils/glossary";
import { researchContent } from "../../content/research";
import researchFilterScript from "../../scripts/research-filter.ts?url";

const {
  pageTitle,
  pageDescription,
  permalink,
  publication,
  anchorLinks,
  panelCopy,
  standardsTimeline,
  orientationCards,
  bridgeArtifacts,
  agenda,
  focusAreas,
  publications,
  lastUpdated,
  updateCadence,
} = researchContent;
const glossaryHref = (slug: string) => glossaryEntryPermalink(slug);
const summaryLinks = anchorLinks.slice(0, 5);
const summaryRelatedLinks = [
  { href: "/glossary", label: "Glossary" },
  { href: "/standards", label: "Standards" },
  { href: "/mechanisms", label: "Mechanisms" },
];
const summaryTakeaways = [
  "Every research line is linked back to glossary anchors.",
  "Bridge artifacts translate field work into citable outputs.",
  "Publications surface data, ethics, and structured abstracts.",
];
const researchTags = Array.from(
  new Set([
    ...bridgeArtifacts.flatMap((artifact) => artifact.tags),
    ...publications.flatMap((publication) => publication.tags),
  ]),
).sort((a, b) => a.localeCompare(b, "en", { sensitivity: "base" }));
const publicationTypes = Array.from(
  new Set(publications.map((publication) => publication.type)),
).sort((a, b) => a.localeCompare(b, "en", { sensitivity: "base" }));
const researchSuggestions = Array.from(
  new Set([
    ...orientationCards.map((card) => card.title),
    ...bridgeArtifacts.flatMap((artifact) => [
      artifact.title,
      ...artifact.tags,
    ]),
    ...publications.flatMap((publication) => [
      publication.title,
      ...publication.tags,
    ]),
    ...agenda.map((item) => item.title),
    ...focusAreas.map((area) => area.title),
  ]),
).sort((a, b) => a.localeCompare(b, "en", { sensitivity: "base" }));
const researchSections = [
  { id: "", label: "All sections" },
  { id: "orientation", label: "Orientation" },
  { id: "bridge-artifacts", label: "Bridge artifacts" },
  { id: "agenda", label: "Agenda" },
  { id: "focus-areas", label: "Focus areas" },
  { id: "publications", label: "Publications" },
];
const buildSearchText = (...parts: Array<string | string[] | undefined>) =>
  parts
    .flatMap((part) => (Array.isArray(part) ? part : part ? [part] : []))
    .join(" ")
    .trim();
const totalResearchItems =
  orientationCards.length +
  bridgeArtifacts.length +
  agenda.length +
  focusAreas.length +
  publications.length;
const pageUrl = Astro.site
  ? new URL(permalink, Astro.site).toString()
  : permalink;
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "@id": pageUrl,
  name: pageTitle,
  description: pageDescription,
  url: pageUrl,
  hasPart: [
    ...bridgeArtifacts.map((artifact) => ({
      "@type": "CreativeWork",
      name: artifact.title,
      description: artifact.summary,
      url: Astro.site
        ? new URL(artifact.href, Astro.site).toString()
        : artifact.href,
      keywords: artifact.tags,
    })),
    ...publications.map((publication) => ({
      "@type": "Report",
      name: publication.title,
      description: publication.summary,
      url: Astro.site
        ? new URL(publication.href, Astro.site).toString()
        : publication.href,
      keywords: publication.tags,
    })),
  ],
};
const structuredDataJson = JSON.stringify(structuredData, null, 2);
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <PageIntro
    eyebrow="Research"
    title="Research"
    description={pageDescription}
    permalink={permalink}
    anchorLinks={anchorLinks}
    panelCopy={panelCopy}
  />
  <SummaryCallout
    title="Research wayfinding at a glance"
    description="Start with the orientation, then scan active agendas and focus areas to see what is in flight and ready to cite."
    takeaways={summaryTakeaways}
    relatedLinks={summaryRelatedLinks}
    jumpLinks={summaryLinks}
  />
  <ScholarlyMeta publication={publication} permalink={permalink} />
  <CitationBlock
    title={pageTitle}
    permalink={permalink}
    publication={publication}
    variant="compact"
  />
  <SectionBlock
    id="standards-timeline"
    eyebrow="Timeline"
    title="Research contributions to standards"
    description="Milestones that connect field work to STD-01 clauses."
    variant="alt"
  >
    <ol class="standards-timeline" aria-label="Standards research timeline">
      {
        standardsTimeline.map((entry) => (
          <li class="standards-timeline__item">
            <div class="standards-timeline__badge">{entry.period}</div>
            <div class="standards-timeline__body">
              <h3>{entry.title}</h3>
              <p class="muted">{entry.summary}</p>
              <a class="standards-timeline__link" href={entry.href}>
                View {entry.standardRef}
              </a>
            </div>
          </li>
        ))
      }
    </ol>
  </SectionBlock>
  <div class="research-filter" data-research-filter>
    <div class="research-filter__controls">
      <label class="research-filter__label" for="research-filter">
        <span class="visually-hidden">Search research entries</span>
        <input
          id="research-filter"
          name="query"
          type="search"
          inputmode="search"
          placeholder="Search research (e.g., consent)"
          autocomplete="off"
          list="research-filter-suggestions"
        />
      </label>
      <label class="research-filter__facet">
        Section
        <select class="research-filter__select" data-research-filter="section">
          {
            researchSections.map((section) => (
              <option value={section.id}>{section.label}</option>
            ))
          }
        </select>
      </label>
      {
        researchTags.length > 0 && (
          <label class="research-filter__facet">
            Tag
            <select class="research-filter__select" data-research-filter="tag">
              <option value="">All tags</option>
              {researchTags.map((tag) => (
                <option value={tag}>{tag}</option>
              ))}
            </select>
          </label>
        )
      }
      {
        publicationTypes.length > 0 && (
          <label class="research-filter__facet">
            Publication type
            <select class="research-filter__select" data-research-filter="type">
              <option value="">All publication types</option>
              {publicationTypes.map((type) => (
                <option value={type}>{type}</option>
              ))}
            </select>
          </label>
        )
      }
      <button
        class="button ghost button--compact research-filter__clear"
        type="button"
        data-clear-research-filter
      >
        Clear filter
      </button>
    </div>
    <div class="research-filter__actions">
      <button
        class="button ghost button--compact"
        type="button"
        data-research-expand
      >
        Expand sections
      </button>
      <button
        class="button ghost button--compact"
        type="button"
        data-research-collapse
      >
        Collapse sections
      </button>
    </div>
    <datalist id="research-filter-suggestions">
      {researchSuggestions.map((suggestion) => <option value={suggestion} />)}
    </datalist>
    <p class="muted research-filter__hint">
      Search across research entries or narrow by section and tags.
    </p>
    <p
      class="muted research-filter__count"
      aria-live="polite"
      aria-atomic="true"
      data-total={totalResearchItems}
    >
      Showing {totalResearchItems} entries
    </p>
    <p class="muted research-filter__empty" hidden>
      No entries match that search or filter. Try another keyword or browse the
      sections below.
    </p>
  </div>
  <p class="muted small">
    Last updated {
      new Date(lastUpdated).toLocaleDateString("en-US", {
        month: "short",
        year: "numeric",
      })
    }.{" "}
    {updateCadence}
  </p>

  <SectionBlock
    id="orientation"
    eyebrow="Orientation"
    title="How we run the work."
    description="The research backlog combines field-ready protocols with governance anchors so findings travel cleanly into diagnostics and delivery."
    className="section--banded"
  >
    <details class="chunked-section" open data-default-open="true">
      <summary class="chunked-section__summary">
        Orientation cards ({orientationCards.length})
      </summary>
      <div class="chunked-section__body">
        <CardGrid className="grid--two research__grid">
          {
            orientationCards.map((card) => (
              <div
                class="research-filter__item"
                data-research-item
                data-section="orientation"
                data-tags={card.tags.join(" ")}
                data-type=""
                data-search={buildSearchText(
                  card.title,
                  card.description,
                  card.tags,
                )}
              >
                <CardItem
                  title={card.title}
                  description={card.description}
                  tags={card.tags}
                />
              </div>
            ))
          }
        </CardGrid>
      </div>
    </details>
  </SectionBlock>

  <SectionBlock
    id="bridge-artifacts"
    eyebrow="Bridge artifacts"
    title="Whitepaper-style artifacts academics can cite."
    description="Frameworks, taxonomies, instruments, and case series that sit between practice and scholarship."
    variant="alt"
  >
    <details class="chunked-section" data-default-open="false">
      <summary class="chunked-section__summary">
        Bridge artifacts ({bridgeArtifacts.length})
      </summary>
      <div class="chunked-section__body">
        <CardGrid className="grid--two">
          {
            bridgeArtifacts.map((artifact) => (
              <div
                class="research-filter__item"
                data-research-item
                data-section="bridge-artifacts"
                data-tags={artifact.tags.join(" ")}
                data-type={artifact.type ?? ""}
                data-search={buildSearchText(
                  artifact.title,
                  artifact.summary,
                  artifact.type,
                  artifact.tags,
                )}
              >
                <CardItem
                  id={artifact.slug}
                  meta={artifact.type}
                  title={artifact.title}
                  description={artifact.summary}
                  tags={artifact.tags}
                >
                  <div slot="footer" class="card__footer">
                    <a
                      class="button ghost button--compact"
                      href={artifact.href}
                    >
                      View artifact
                    </a>
                  </div>
                </CardItem>
              </div>
            ))
          }
        </CardGrid>
      </div>
    </details>
  </SectionBlock>

  <SectionBlock
    id="agenda"
    eyebrow="Agenda"
    title="In-flight lines of inquiry."
    description="Each line links to glossary terms you can reference in protocols and design docs."
    variant="alt"
  >
    <details class="chunked-section" data-default-open="false">
      <summary class="chunked-section__summary">
        Agenda entries ({agenda.length})
      </summary>
      <div class="chunked-section__body">
        <CardGrid>
          {
            agenda.map((item) => (
              <div
                class="research-filter__item"
                data-research-item
                data-section="agenda"
                data-tags=""
                data-type=""
                data-search={buildSearchText(
                  item.title,
                  item.timeframe,
                  item.goals,
                )}
              >
                <CardItem
                  meta={item.timeframe}
                  title={item.title}
                  tags={item.goals}
                  glossaryLinks={item.glossaryRefs.map((slug) => ({
                    href: glossaryHref(slug),
                    label: getGlossaryLabel(slug),
                    definition: getGlossaryDefinition(slug),
                  }))}
                />
              </div>
            ))
          }
        </CardGrid>
      </div>
    </details>
  </SectionBlock>

  <SectionBlock
    id="focus-areas"
    eyebrow="Focus areas"
    title="Where we spend our attention."
    description="Use these anchors to align research, Field Notes, and diagnostics around the same questions."
  >
    <details class="chunked-section" data-default-open="false">
      <summary class="chunked-section__summary">
        Focus areas ({focusAreas.length})
      </summary>
      <div class="chunked-section__body">
        <CardGrid>
          {
            focusAreas.map((area) => (
              <div
                class="research-filter__item"
                data-research-item
                data-section="focus-areas"
                data-tags=""
                data-type=""
                data-search={buildSearchText(
                  area.title,
                  area.description,
                  area.questions,
                )}
              >
                <CardItem
                  id={area.slug}
                  title={area.title}
                  description={area.description}
                  tags={area.questions}
                  glossaryLinks={area.glossaryRefs.map((slug) => ({
                    href: glossaryHref(slug),
                    label: getGlossaryLabel(slug),
                    definition: getGlossaryDefinition(slug),
                  }))}
                />
              </div>
            ))
          }
        </CardGrid>
      </div>
    </details>
  </SectionBlock>

  <SectionBlock
    id="publications"
    eyebrow="Publications"
    title="Protocols, decks, and reports."
    description="Each entry is tagged with glossary links to help readers dig deeper in the Library."
    variant="alt"
  >
    <details class="chunked-section" data-default-open="false">
      <summary class="chunked-section__summary">
        Publications ({publications.length})
      </summary>
      <div class="chunked-section__body">
        <CardGrid>
          {
            publications.map((publication) => (
              <div
                class="research-filter__item"
                data-research-item
                data-section="publications"
                data-tags={publication.tags.join(" ")}
                data-type={publication.type}
                data-search={buildSearchText(
                  publication.title,
                  publication.summary,
                  publication.type,
                  publication.tags,
                  publication.structuredAbstract.question,
                )}
              >
                <CardItem
                  meta={publication.type}
                  title={publication.title}
                  description={publication.summary}
                  descriptionTone="default"
                  tags={publication.tags}
                  glossaryLinks={publication.glossaryRefs.map((slug) => ({
                    href: glossaryHref(slug),
                    label: getGlossaryLabel(slug),
                    definition: getGlossaryDefinition(slug),
                  }))}
                >
                  <div class="research__abstract">
                    <p class="eyebrow">Structured abstract</p>
                    <ul class="muted">
                      <li>
                        <strong>Question:</strong>{" "}
                        {publication.structuredAbstract.question}
                      </li>
                      <li>
                        <strong>Method:</strong>{" "}
                        {publication.structuredAbstract.method}
                      </li>
                      <li>
                        <strong>Sample/context:</strong>{" "}
                        {publication.structuredAbstract.sample}
                      </li>
                      <li>
                        <strong>Findings:</strong>{" "}
                        {publication.structuredAbstract.findings}
                      </li>
                      <li>
                        <strong>Limitations:</strong>{" "}
                        {publication.structuredAbstract.limitations}
                      </li>
                    </ul>
                  </div>
                  <div class="research__data">
                    <p class="eyebrow">Data & artifacts</p>
                    <ul class="muted">
                      {publication.datasets.map((dataset) => (
                        <li>{dataset}</li>
                      ))}
                    </ul>
                    <p class="eyebrow">Ethics & consent</p>
                    <ul class="muted">
                      {publication.ethicsNotes.map((note) => (
                        <li>{note}</li>
                      ))}
                    </ul>
                    <p class="eyebrow">References</p>
                    <ul class="muted">
                      {publication.references.map((reference) => (
                        <li>
                          <a href={reference.href}>{reference.label}</a>
                        </li>
                      ))}
                    </ul>
                  </div>
                  <div slot="footer" class="card__footer">
                    <a
                      class="button ghost button--compact"
                      href={publication.href}
                    >
                      {publication.ctaLabel}
                    </a>
                  </div>
                </CardItem>
              </div>
            ))
          }
        </CardGrid>
      </div>
    </details>
  </SectionBlock>
  <script type="application/ld+json" set:html={structuredDataJson} is:inline />
  <script type="module" src={researchFilterScript} is:inline></script>
</BaseLayout>
