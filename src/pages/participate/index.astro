---
import { getEntry } from "astro:content";
import { Icon } from "astro-icon/components";

import CardGrid from "../../components/CardGrid.astro";
import CardItem from "../../components/CardItem.astro";
import FeedbackRibbon from "../../components/FeedbackRibbon.astro";
import PageIntro from "../../components/PageIntro.astro";
import SectionBlock from "../../components/SectionBlock.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";

const participationEntry = (await getEntry("participation", "participation"))!;
const {
  pageTitle,
  pageDescription,
  permalink,
  hero,
  pathways,
  openSource,
  intake,
  feedback,
} = participationEntry.data;
const intakeFieldNameMap: Record<string, string> = {
  "participant-name": "name",
  "participant-organization": "organization",
  "participant-email": "email",
  "participant-type": "topic",
  "participant-summary": "details",
};
const intakeFieldAutocompleteMap: Record<string, string> = {
  "participant-name": "name",
  "participant-organization": "organization",
  "participant-email": "email",
  "participant-type": "off",
  "participant-summary": "off",
};
type InputMode =
  | "none"
  | "text"
  | "tel"
  | "url"
  | "email"
  | "numeric"
  | "decimal"
  | "search";
const intakeFieldInputModeMap: Record<string, InputMode> = {
  "participant-email": "email",
};
const intakeFieldAutocapitalizeMap: Record<string, string> = {
  "participant-name": "words",
  "participant-organization": "words",
  "participant-email": "none",
  "participant-type": "sentences",
  "participant-summary": "sentences",
};
const resolveIntakeFieldName = (fieldId: string) =>
  intakeFieldNameMap[fieldId] ?? fieldId;
const resolveIntakeFieldAutocomplete = (fieldId: string) =>
  intakeFieldAutocompleteMap[fieldId] ?? "off";
const resolveIntakeFieldInputMode = (fieldId: string) =>
  intakeFieldInputModeMap[fieldId];
const resolveIntakeFieldAutocapitalize = (fieldId: string) =>
  intakeFieldAutocapitalizeMap[fieldId] ?? "sentences";
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <PageIntro
    eyebrow={hero.eyebrow}
    title={hero.heading}
    description={hero.description}
    permalink={permalink}
    anchorLinks={hero.anchorLinks}
    panelCopy={hero.panel}
  />

  <SectionBlock
    id="field-reports"
    eyebrow="Contribute"
    title="Share the work that should be in the mechanisms catalog"
    description="Send concrete stories, drafts, and experiments so we can publish what teams actually need."
    className="section--banded"
  >
    <CardGrid className="grid--three">
      {
        pathways.map((pathway) => (
          <CardItem
            id={pathway.id}
            title={pathway.title}
            description={pathway.description}
            descriptionTone="default"
            tags={pathway.tags}
          >
            <ul class="muted">
              {pathway.checklist.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
            {pathway.actions.length ? (
              <ul class="card__list">
                {pathway.actions.map((action) => (
                  <li>
                    <a
                      href={action.href}
                      aria-label={action.ariaLabel ?? action.label}
                    >
                      {action.label}
                    </a>
                  </li>
                ))}
              </ul>
            ) : null}
          </CardItem>
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id={openSource.id}
    eyebrow={openSource.eyebrow}
    title={openSource.title}
    description={openSource.description}
    variant="alt"
  >
    <CardGrid className="grid--two">
      {
        openSource.items.map((item) => (
          <CardItem title={item.title} description={item.description}>
            <ul class="card__list">
              {item.actions.map((action) => (
                <li>
                  <a
                    href={action.href}
                    aria-label={action.ariaLabel ?? action.label}
                    rel={
                      action.href.startsWith("http")
                        ? "noopener noreferrer"
                        : undefined
                    }
                  >
                    {action.label}
                  </a>
                </li>
              ))}
            </ul>
          </CardItem>
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="intake"
    eyebrow={intake.eyebrow}
    title={intake.title}
    description={intake.description}
  >
    <p class="muted small" id="intake-format-note">
      {intake.formatNote}
    </p>

    <div id="intake-form-container">
      <form
        id="intake-form"
        class="intake-form"
        method="POST"
        aria-describedby="intake-format-note intake-response-note intake-timeline-note intake-privacy-note"
      >
        <div class="intake-form__grid">
          {
            intake.form.fields.map((field) => {
              const fieldName = resolveIntakeFieldName(field.id);
              const fieldAutocomplete = resolveIntakeFieldAutocomplete(field.id);
              const fieldInputMode = resolveIntakeFieldInputMode(field.id);
              const fieldAutocapitalize = resolveIntakeFieldAutocapitalize(
                field.id,
              );

              return (
                <label
                  class={`intake-form__field${
                    field.type === "textarea" ? " intake-form__field--full" : ""
                  }`}
                  for={field.id}
                >
                  <span class="muted">{field.label}</span>
                  {field.type === "textarea" ? (
                    <textarea
                      id={field.id}
                      name={fieldName}
                      placeholder={field.placeholder}
                      autocomplete={fieldAutocomplete}
                      inputmode={fieldInputMode}
                      autocapitalize={fieldAutocapitalize}
                      required={field.required}
                      rows={4}
                    />
                  ) : (
                    <input
                      id={field.id}
                      name={fieldName}
                      type={field.type}
                      placeholder={field.placeholder}
                      autocomplete={fieldAutocomplete}
                      inputmode={fieldInputMode}
                      autocapitalize={fieldAutocapitalize}
                      required={field.required}
                    />
                  )}
                </label>
              );
            })
          }
        </div>
        <div class="intake-form__actions">
          <button class="button primary" type="submit" id="submit-btn">
            {intake.form.submitLabel}
          </button>
          <p class="muted small" id="intake-response-note">
            {intake.responseNote}
          </p>
          <p class="muted small" id="intake-timeline-note">
            {intake.timelineNote}
          </p>
        </div>
        <p class="muted small" id="intake-privacy-note">
          {intake.privacyNote}
        </p>
        <div
          id="form-message"
          class="form-message"
          role="status"
          aria-live="polite"
          aria-atomic="true"
        ></div>
      </form>

      <div
        id="success-message"
        class="success-message"
        role="status"
        aria-live="polite"
        hidden
      >
        <div class="success-message__content">
          <div class="success-message__icon">
            <Icon name="lucide:check" />
          </div>
          <h3>Received</h3>
          <p>Thank you for your submission. We'll be in touch soon.</p>
          <button class="button ghost" id="reset-btn" type="button">
            Send another submission
          </button>
        </div>
      </div>
    </div>

    <script>
      import { actions } from "astro:actions";

      const form = document.getElementById("intake-form") as HTMLFormElement;
      const submitBtn = document.getElementById(
        "submit-btn",
      ) as HTMLButtonElement;
      const messageDiv = document.getElementById("form-message");
      const container = document.getElementById("intake-form-container");
      const successDiv = document.getElementById("success-message");
      const resetBtn = document.getElementById("reset-btn");

      if (
        form &&
        submitBtn &&
        messageDiv &&
        container &&
        successDiv &&
        resetBtn
      ) {
        const storageKey = "participation-intake";
        const saveDraft = () => {
          const formData = new FormData(form);
          const payload = Object.fromEntries(formData.entries());
          localStorage.setItem(storageKey, JSON.stringify(payload));
        };

        const restoreDraft = () => {
          const saved = localStorage.getItem(storageKey);
          if (!saved) return;
          try {
            const parsed = JSON.parse(saved);
            Object.entries(parsed).forEach(([key, value]) => {
              const field = form.elements.namedItem(key);
              if (
                field instanceof HTMLInputElement ||
                field instanceof HTMLTextAreaElement
              ) {
                field.value = String(value);
              }
            });
          } catch (error) {
            console.error("Unable to restore intake draft", error);
          }
        };

        restoreDraft();
        form.addEventListener("input", saveDraft);
        form.addEventListener("blur", saveDraft, true);

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!form.reportValidity()) {
            const firstInvalid = form.querySelector<HTMLElement>(":invalid");
            firstInvalid?.focus();
            return;
          }

          // Reset previous states
          messageDiv.textContent = "";
          messageDiv.className = "form-message";
          submitBtn.disabled = true;
          const originalBtnText = submitBtn.textContent;
          submitBtn.textContent = "Sending...";

          const formData = new FormData(form);

          // Map fields if necessary to match action schema
          // The form fields in content might not match exactly what our action expects
          // We'll trust the form content matches or is close enough, checking specific overrides

          const result = await actions.intake(formData);

          submitBtn.disabled = false;
          submitBtn.textContent = originalBtnText;

          if (!result.error) {
            // Success
            form.hidden = true;
            successDiv.hidden = false;
            form.reset();
            localStorage.removeItem(storageKey);
          } else {
            // Error
            messageDiv.textContent =
              result.error.message ||
              "Something went wrong. Please try again or use the feedback inbox below.";
            messageDiv.classList.add("error");
          }
        });

        resetBtn.addEventListener("click", () => {
          successDiv.hidden = true;
          form.hidden = false;
          messageDiv.textContent = "";
          messageDiv.className = "form-message";
          form.reset();
          localStorage.removeItem(storageKey);
        });
      }
    </script>
  </SectionBlock>

  <SectionBlock
    id="feedback"
    eyebrow={feedback.eyebrow}
    title={feedback.title}
    description={feedback.description}
    variant="alt"
  >
    <FeedbackRibbon
      eyebrow="Feedback inboxes"
      title="Send notes, critiques, or missing references."
      description="Share unclear steps, missing citations, or examples you want us to add."
      actions={feedback.actions}
    />
  </SectionBlock>
</BaseLayout>
