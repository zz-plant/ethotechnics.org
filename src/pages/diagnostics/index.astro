---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CardGrid from '../../components/CardGrid.astro';
import CardItem from '../../components/CardItem.astro';
import PageIntro from '../../components/PageIntro.astro';
import SectionBlock from '../../components/SectionBlock.astro';
import { diagnosticsContent } from '../../content/diagnostics';
import { libraryContent } from '../../content/library';
import diagnosticsFilterScript from '../../scripts/diagnostics-filter.ts?url';

const { pageTitle, pageDescription, permalink, tools, offRampNote, valueProps, facilitation } =
  diagnosticsContent;
const patternBase = `${libraryContent.permalink}#patterns`;
const anchorLinks = [
  { href: '#why-diagnostics', label: 'What you get' },
  { href: '#how-it-works', label: 'How sessions run' },
  { href: '#diagnostic-tools', label: 'Diagnostics menu' },
  ...tools.map((tool) => ({ href: `#${tool.slug}`, label: tool.title })),
];
const introDescription = `${pageDescription} These tools are public under CC BY through the Institute; Studio uses the same models with bespoke facilitation via ethotechnics.com/studio.`;
---
<BaseLayout title={pageTitle} description={pageDescription}>
  <PageIntro
    eyebrow="Diagnostics"
    title="Diagnostics"
    description={introDescription}
    permalink={permalink}
    anchorLinks={anchorLinks}
    panelCopy={{
      eyebrow: 'Results and off-ramps',
      title: 'Every diagnostic leaves you with a linkable readout.',
      description:
        'Outputs include a stable URL, the off-ramp to ethotechnics.com/studio, and pattern language references for follow-up.',
      link: {
        label: 'Compare tools',
        href: '#compare-tools',
      },
    }}
  />

  <SectionBlock
    id="compare-tools"
    eyebrow="Compare tools"
    title="Start with the quickest diagnostic that matches your decision."
    description="Use the summary below to pick your best fit before scanning the full menu."
    variant="alt"
  >
    <ul class="diagnostics__compare">
      <li>
        <p class="muted diagnostics__label">Delivery & timing</p>
        <p class="muted">Each tool notes whether it is self-serve or studio-facilitated, plus the expected time.</p>
      </li>
      <li>
        <p class="muted diagnostics__label">Best for</p>
        <p class="muted">One sentence captures the scenario the tool is optimized for.</p>
      </li>
      <li>
        <p class="muted diagnostics__label">Outputs & prep</p>
        <p class="muted">Scan the readout list and prep checklist to confirm the lift.</p>
      </li>
      <li>
        <p class="muted diagnostics__label">Pattern language</p>
        <p class="muted">
          Use the <a href={patternBase}>pattern library</a> to align mitigations after you compare.
        </p>
      </li>
    </ul>
  </SectionBlock>

  <SectionBlock
    id="why-diagnostics"
    eyebrow="Why teams call us"
    title="Diagnostics turn fuzzy risk into a concrete next step."
    description="Built for visitors who need a clear answer without a long engagement."
  >
    <CardGrid>
      {valueProps.map((item) => (
        <CardItem title={item.title} description={item.description} />
      ))}
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="how-it-works"
    eyebrow="Facilitated, but lightweight"
    title={facilitation.title}
    description={facilitation.description}
    variant="alt"
  >
    <ol class="diagnostics__process">
      {facilitation.steps.map((step) => (
        <li class="diagnostics__process-step">
          <p class="eyebrow">{step.title}</p>
          <p class="muted">{step.detail}</p>
        </li>
      ))}
    </ol>
    <p class="muted diagnostics__footnote">{facilitation.note}</p>
  </SectionBlock>

  <SectionBlock
    id="diagnostic-tools"
    eyebrow="Diagnostics menu"
    title="Pick the tool that matches your situation."
    description={`Every diagnostic ships with a linkable result and an off-ramp. ${offRampNote}`}
  >
    <div class="diagnostics__filters" data-diagnostics-filters>
      <p class="muted">Filter by delivery type</p>
      <ul class="pill-list pill-list--wrap" role="group" aria-label="Diagnostic delivery filters">
        <li class="pill-list__item pill-list__item--active">
          <button class="pill-list__button" type="button" data-delivery-filter="all" aria-pressed="true">
            All diagnostics
          </button>
        </li>
        <li class="pill-list__item">
          <button class="pill-list__button" type="button" data-delivery-filter="self-serve" aria-pressed="false">
            Self-serve
          </button>
        </li>
        <li class="pill-list__item">
          <button class="pill-list__button" type="button" data-delivery-filter="studio" aria-pressed="false">
            Studio-facilitated
          </button>
        </li>
      </ul>
      <p class="muted small" data-delivery-status>
        Showing all diagnostics.
      </p>
    </div>
    <CardGrid className="diagnostics__tool-grid" data-diagnostics-grid>
      {tools.map((tool) => (
        <CardItem
          id={tool.slug}
          eyebrow="Diagnostic tool"
          title={tool.title}
          description={tool.description}
          headingLevel="h2"
          dataDelivery={tool.deliveryType}
        >
          <div class="diagnostics__card-body">
            <div>
              <p class="muted small">
                {tool.deliveryType === 'studio' ? 'Studio-facilitated' : 'Self-serve'}
              </p>
              <p class="muted small">Estimated time: {tool.estimatedTime}</p>
            </div>
            <p class="muted small diagnostics__best-for">{tool.bestFor}</p>
            <ul class="diagnostics__summary">
              <li>
                <p class="muted diagnostics__label">Use this when</p>
                <ul class="pill-list pill-list--wrap">
                  {tool.readiness.map((item) => (
                    <li>{item}</li>
                  ))}
                </ul>
              </li>
              <li>
                <p class="muted diagnostics__label">What you receive</p>
                <ul class="pill-list pill-list--wrap">
                  {tool.outputs.map((item) => (
                    <li>{item}</li>
                  ))}
                </ul>
              </li>
              <li>
                <p class="muted diagnostics__label">Prep checklist</p>
                <ul class="pill-list pill-list--wrap">
                  {tool.prepChecklist.map((item) => (
                    <li>{item}</li>
                  ))}
                </ul>
              </li>
            </ul>
            <p class="muted small">{tool.studioNote}</p>
          </div>
          <div class="diagnostics__card-footer">
            <div class="section__actions">
              <a class="button primary" href={tool.ctaHref} aria-label={tool.ctaAriaLabel ?? tool.ctaLabel}>
                {tool.ctaLabel}
              </a>
              <a
                class="button ghost"
                href={tool.exampleHref}
                aria-label={`View example outputs for ${tool.title}`}
              >
                {tool.exampleLabel}
              </a>
            </div>
            <p class="muted diagnostics__pairing">
              Pair with <a href={patternBase}>pattern language</a> entries referenced in Library for consistent mitigation.
            </p>
          </div>
        </CardItem>
      ))}
    </CardGrid>
  </SectionBlock>
  <script type="module" src={diagnosticsFilterScript}></script>
</BaseLayout>
