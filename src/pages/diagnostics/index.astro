---
import BaseLayout from "../../layouts/BaseLayout.astro";
import CardGrid from "../../components/CardGrid.astro";
import CardItem from "../../components/CardItem.astro";
import CitationBlock from "../../components/CitationBlock.astro";
import PageIntro from "../../components/PageIntro.astro";
import ScholarlyMeta from "../../components/ScholarlyMeta.astro";
import SectionActions from "../../components/SectionActions.astro";
import SectionBlock from "../../components/SectionBlock.astro";
import StudioBadge from "../../components/StudioBadge.astro";
import { diagnosticsContent } from "../../content/diagnostics";
import { libraryContent } from "../../content/library";
import diagnosticsFilterScript from "../../scripts/diagnostics-filter.ts?url";

const {
  pageTitle,
  pageDescription,
  permalink,
  tools,
  valueProps,
  facilitation,
  publication,
} = diagnosticsContent;
const mechanismBase = `${libraryContent.permalink}#mechanisms`;
const anchorLinks = [
  { href: "#why-diagnostics", label: "What you get" },
  { href: "#output-baseline", label: "Output baseline" },
  { href: "#anti-weaponization", label: "Anti-weaponization checks" },
  { href: "#quick-triage", label: "Quick triage" },
  { href: "#how-it-works", label: "How sessions run" },
  { href: "#diagnostic-tools", label: "Diagnostics menu" },
  { href: "#referenced-by", label: "Referenced by" },
  ...tools.map((tool) => ({ href: `#${tool.slug}`, label: tool.title })),
];
const introDescription =
  "This page is for operators, governance teams, and auditors who need decision-ready diagnostics. " +
  pageDescription;
const quickTriagePrompts = [
  {
    question:
      "Do you need a fast workload snapshot before teams hit burnout thresholds?",
    description: "Quantify task load and hotspot relief paths.",
    href: "/diagnostics/burden-modeler",
    label: "Open Burden Modeler",
  },
  {
    question: "Are you rehearsing outage coverage or escalation ownership?",
    description: "Simulate maintenance branches and comms coverage.",
    href: "/diagnostics/maintenance-simulator",
    label: "Open Maintenance Simulator",
  },
  {
    question: "Are you modeling capacity decay or saturation risk over time?",
    description: "Forecast long-term stability and remediation timing.",
    href: "/diagnostics/capacity-forecaster",
    label: "Open Capacity Forecaster",
  },
];
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <PageIntro
    eyebrow="Diagnostics"
    title="Diagnostics"
    description={introDescription}
    permalink={permalink}
    anchorLinks={anchorLinks}
    panelCopy={{
      eyebrow: "Decision-ready outputs",
      title: "Every diagnostic leaves you with a linkable readout.",
      description:
        "Outputs include a stable URL and mechanism language references for follow-up.",
      link: {
        label: "Compare tools",
        href: "#compare-tools",
      },
    }}
  />
  <SectionActions>
    <StudioBadge />
  </SectionActions>
  <ScholarlyMeta publication={publication} permalink={permalink} />
  <CitationBlock
    title={pageTitle}
    permalink={permalink}
    publication={publication}
    variant="compact"
  />

  <SectionBlock
    id="compare-tools"
    eyebrow="Compare tools"
    title="Start with the quickest diagnostic that matches your decision."
    description="Use the summary below to pick your best fit before scanning the full menu."
    variant="alt"
  >
    <ul class="diagnostics__compare">
      <li>
        <p class="muted diagnostics__label">Delivery & timing</p>
        <p class="muted">
          Each tool notes whether it is self-serve or studio-facilitated, plus
          the expected time.
        </p>
      </li>
      <li>
        <p class="muted diagnostics__label">Best for</p>
        <p class="muted">
          One sentence captures the scenario the tool is optimized for.
        </p>
      </li>
      <li>
        <p class="muted diagnostics__label">Outputs & prep</p>
        <p class="muted">
          Scan the readout list and prep checklist to confirm the lift.
        </p>
      </li>
      <li>
        <p class="muted diagnostics__label">Mechanism language</p>
        <p class="muted">
          Use the <a href={mechanismBase}>mechanisms catalog</a> to align mitigations
          after you compare.
        </p>
      </li>
    </ul>
  </SectionBlock>

  <SectionBlock
    id="why-diagnostics"
    eyebrow="Why teams call us"
    title="Diagnostics turn fuzzy risk into a concrete next step."
    description="Built for visitors who need a clear answer without a long engagement."
  >
    <CardGrid>
      {
        valueProps.map((item) => (
          <CardItem title={item.title} description={item.description} />
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="output-baseline"
    eyebrow="Output baseline"
    title="What every diagnostic output includes."
    description="Use the shared baseline to align teams before diving into tool specifics."
    variant="alt"
  >
    <ul class="muted">
      <li>Linkable results page and a shareable PDF summary.</li>
      <li>Mechanism language references to keep mitigations consistent.</li>
      <li>Optional facilitation handoff when ambiguity or risk stays high.</li>
    </ul>
    <StudioBadge />
  </SectionBlock>

  <SectionBlock
    id="anti-weaponization"
    eyebrow="Anti-weaponization"
    title="Diagnostics must verify AW-01 through AW-04"
    description="Every diagnostic output should include evidence that anti-weaponization clauses are honored."
  >
    <ul class="muted">
      <li>
        AW-01: Burden metrics include a remediation plan and staffing
        allocation.
      </li>
      <li>
        AW-02: Appeal paths are tested for non-regression and public replacement
        windows.
      </li>
      <li>
        AW-03: Downgrades or eligibility changes always emit receipts and
        clocks.
      </li>
      <li>
        AW-04: High-burden flows include assisted channels or human escalation.
      </li>
    </ul>
    <p class="muted">
      Reference:
      {" "}
      <a href="/anti-weaponization">Anti-weaponization constraints</a>
      {" "}
      and the
      {" "}
      <a href="/evidence-packs/std-02#anti-weaponization"
        >evidence requirements</a
      >.
    </p>
  </SectionBlock>

  <SectionBlock
    id="quick-triage"
    eyebrow="Quick triage"
    title="Pick the fastest diagnostic path in three questions."
    description="Use these prompts to route to the right tool without the demo widget."
  >
    <CardGrid className="grid--three">
      {
        quickTriagePrompts.map((prompt) => (
          <CardItem
            title={prompt.question}
            description={prompt.description}
            descriptionTone="default"
          >
            <a slot="footer" class="muted" href={prompt.href}>
              {prompt.label}
            </a>
          </CardItem>
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="how-it-works"
    eyebrow="Facilitated, but lightweight"
    title={facilitation.title}
    description={facilitation.description}
    variant="alt"
  >
    <ol class="diagnostics__process">
      {
        facilitation.steps.map((step) => (
          <li class="diagnostics__process-step">
            <p class="eyebrow">{step.title}</p>
            <p class="muted">{step.detail}</p>
          </li>
        ))
      }
    </ol>
    <p class="muted diagnostics__footnote">{facilitation.note}</p>
  </SectionBlock>

  <SectionBlock
    id="diagnostic-tools"
    eyebrow="Diagnostics menu"
    title="Pick the tool that matches your situation."
    description="Every diagnostic ships with a linkable result and mechanism references."
  >
    <div class="diagnostics__filters" data-diagnostics-filters>
      <p class="muted">Filter by delivery type</p>
      <ul
        class="pill-list pill-list--wrap"
        role="group"
        aria-label="Diagnostic delivery filters"
      >
        <li class="pill-list__item pill-list__item--active">
          <button
            class="pill-list__button"
            type="button"
            data-delivery-filter="all"
            aria-pressed="true"
          >
            All diagnostics
          </button>
        </li>
        <li class="pill-list__item">
          <button
            class="pill-list__button"
            type="button"
            data-delivery-filter="self-serve"
            aria-pressed="false"
          >
            Self-serve
          </button>
        </li>
        <li class="pill-list__item">
          <button
            class="pill-list__button"
            type="button"
            data-delivery-filter="studio"
            aria-pressed="false"
          >
            Studio-facilitated
          </button>
        </li>
      </ul>
      <p class="muted small" data-delivery-status>Showing all diagnostics.</p>
    </div>
    <CardGrid className="diagnostics__tool-grid" data-diagnostics-grid>
      {
        tools.map((tool) => {
          const isStudio = tool.deliveryType === "studio";
          const deliveryLabel = isStudio
            ? "Studio-facilitated session"
            : "Self-serve tool";
          const deliveryDetail = isStudio
            ? "Facilitation required; request a session to run this diagnostic."
            : "Run on demand and share the linkable readout immediately.";
          const primaryCtaLabel = isStudio ? "Request session" : "Run";

          return (
            <CardItem
              id={tool.slug}
              eyebrow="Diagnostic tool"
              title={tool.title}
              description={tool.description}
              headingLevel="h2"
              dataDelivery={tool.deliveryType}
            >
              <div class="diagnostics__card-body">
                <div>
                  <p class="muted small">{deliveryLabel}</p>
                  <p class="muted small">{deliveryDetail}</p>
                  <p class="muted small">Estimated time: {tool.estimatedTime}</p>
                </div>
                <p class="muted small diagnostics__best-for">{tool.bestFor}</p>
                <ul class="diagnostics__summary">
                  <li>
                    <p class="muted diagnostics__label">Use this when</p>
                    <ul class="pill-list pill-list--wrap">
                      {tool.readiness.map((item) => (
                        <li>{item}</li>
                      ))}
                    </ul>
                  </li>
                  <li>
                    <p class="muted diagnostics__label">What you receive</p>
                    <ul class="pill-list pill-list--wrap">
                      {tool.outputs.map((item) => (
                        <li>{item}</li>
                      ))}
                    </ul>
                  </li>
                  <li>
                    <p class="muted diagnostics__label">Prep checklist</p>
                    <ul class="pill-list pill-list--wrap">
                      {tool.prepChecklist.map((item) => (
                        <li>{item}</li>
                      ))}
                    </ul>
                  </li>
                </ul>
              </div>
              <div class="diagnostics__card-footer">
                <SectionActions>
                  <a
                    class="button primary"
                    href={tool.ctaHref}
                    aria-label={
                      tool.ctaAriaLabel ?? `${primaryCtaLabel} ${tool.title}`
                    }
                  >
                    {primaryCtaLabel}
                  </a>
                  <a class="button ghost" href={`/diagnostics/${tool.slug}`}>
                    Method details
                  </a>
                  <a
                    class="button ghost"
                    href={tool.exampleHref}
                    aria-label={`View example outputs for ${tool.title}`}
                  >
                    {tool.exampleLabel}
                  </a>
                </SectionActions>
              </div>
            </CardItem>
          );
        })
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="referenced-by"
    eyebrow="Referenced by"
    title="Where diagnostics connect to enforcement"
    description="Cross-links keep diagnostic outputs aligned with standards, bindings, and evidence packs."
    variant="alt"
  >
    <div class="grid grid--three">
      <div class="panel">
        <p class="eyebrow">Used in examples</p>
        <ul class="muted">
          <li>
            <a href="/examples/automated-account-lock">Automated account lock</a
            >
          </li>
          <li>
            <a href="/examples/content-moderation-takedown"
              >Content moderation takedown</a
            >
          </li>
          <li>
            <a href="/examples/fraud-hold-delayed-notice"
              >Fraud hold with delayed notice</a
            >
          </li>
        </ul>
      </div>
      <div class="panel">
        <p class="eyebrow">Required by bindings</p>
        <ul class="muted">
          <li>
            <a href="/bindings#incidents">Incident triggers</a>
          </li>
          <li>
            <a href="/bindings#runbooks">Runbook snippets</a>
          </li>
          <li>
            <a href="/bindings#release-gates">Release gate checklist</a>
          </li>
        </ul>
      </div>
      <div class="panel">
        <p class="eyebrow">Verified by evidence packs</p>
        <ul class="muted">
          <li>
            <a href="/evidence-packs/std-01">STD-01 Evidence Pack</a>
          </li>
          <li>
            <a href="/evidence-packs/std-02">STD-02 Evidence Pack</a>
          </li>
          <li>
            <a href="/validators">Validators (VAL-01â€“VAL-03)</a>
          </li>
        </ul>
      </div>
    </div>
    <p class="muted">
      Bundles:
      {" "}
      <a href="/bundles/diagnostic-export-kit">Diagnostic Export Kit</a>
      {" "}
      for stakeholder summaries and
      {" "}
      <a href="/bundles/procurement-clause-pack">Procurement Clause Pack</a>
      {" "}
      for vendor follow-through.
    </p>
    <p class="muted">
      Search IDs: AW-01, AW-02, AW-03, AW-04, VAL-01, VAL-02, VAL-03,
      STD-02.2.1, STD-02.3.1.
    </p>
  </SectionBlock>
  <script type="module" src={diagnosticsFilterScript} is:inline></script>
</BaseLayout>
