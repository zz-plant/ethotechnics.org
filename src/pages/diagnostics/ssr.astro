---
import DiagnosticsSnapshot from '../../components/DiagnosticsSnapshot';
import BaseLayout from '../../layouts/BaseLayout.astro';

const request = Astro.request;
const url = new URL(request.url);
const renderedAt = new Date().toISOString();
const requestId = crypto.randomUUID();
const headersToReport = ['cf-connecting-ip', 'accept-language', 'user-agent'];

const headerEntries = headersToReport.map((key) => ({
  key,
  value: request.headers.get(key) ?? 'Not provided',
}));

const initialSnapshot = {
  renderedAt,
  requestId,
  method: request.method,
  path: `${url.pathname}${url.search}`,
  origin: request.headers.get('host') ?? 'Not provided',
  cacheControl: request.headers.get('cache-control') ?? 'Not provided',
  headers: headerEntries,
};

Astro.response.headers.set('cache-control', 'no-store');
---
<BaseLayout
  title="SSR diagnostics â€” Ethotechnics"
  description="Runtime view of the request context to verify Astro server rendering on Cloudflare."
>
  <section class="section">
    <div class="section__header">
      <p class="eyebrow">Diagnostics</p>
      <h1>Server-side rendering check</h1>
      <p class="muted">
        Use this page to confirm that requests are handled by the server runtime. Refresh to see the timestamp, request ID,
        and header values change for each request.
      </p>
      <p class="muted">
        Permanent link: <a href="/diagnostics/ssr">/diagnostics/ssr</a>
      </p>
    </div>
    <div class="panel panel--glass">
      <DiagnosticsSnapshot
        client:load
        initialSnapshot={initialSnapshot}
        refreshUrl="/diagnostics/ssr.json"
        intervalMs={15000}
      />
    </div>
  </section>

  <section class="section section--alt">
    <div class="callout">
      <h3>Why this page exists</h3>
      <p class="muted">
        The site runs with Astro's server output on Cloudflare Workers. This check proves hydration-free SSR paths are
        working and that responses are not cached across requests.
      </p>
      <p class="muted">
        For integration testing, assert that the timestamp and request ID change on refresh and that headers match the
        client or proxy making the request.
      </p>
      <a class="button ghost" href="/diagnostics">Back to diagnostics</a>
    </div>
  </section>
</BaseLayout>
