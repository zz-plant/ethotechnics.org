---
import DiagnosticsSnapshot from '../../components/DiagnosticsSnapshot';
import { buildDiagnosticsSnapshot } from '../../lib/diagnostics/snapshot';
import BaseLayout from '../../layouts/BaseLayout.astro';

const initialSnapshot = buildDiagnosticsSnapshot(Astro.request);

Astro.response.headers.set('cache-control', 'no-store');
---
<BaseLayout
  title="SSR diagnostics â€” Ethotechnics"
  description="Runtime view of the request context to verify Astro server rendering on Cloudflare."
>
  <section class="section">
    <div class="section__header">
      <p class="eyebrow">Diagnostics</p>
      <h1>Server-side rendering check</h1>
      <p class="muted">
        Use this page to confirm that requests are handled by the server runtime. Refresh to see the timestamp, request ID,
        and header values change for each request.
      </p>
      <p class="muted">
        This SSR check gives teams a live view of the timestamp, request ID, and request headers so they can confirm
        per-request rendering and verify caches are bypassed.
      </p>
      <p class="muted">
        Permanent link: <a href="/diagnostics/ssr">/diagnostics/ssr</a>
      </p>
    </div>
    <div class="callout">
      <h2>Developer-only diagnostic</h2>
      <p class="muted">
        This page is intended for engineers validating Cloudflare SSR behavior. If you are looking for user-facing diagnostics,
        return to the diagnostics menu.
      </p>
      <a class="button ghost" href="/diagnostics">Back to diagnostics</a>
    </div>
    <div class="section__actions">
      <a class="button primary" href="#runtime-snapshot" aria-label="Jump to the SSR runtime snapshot">
        Run the SSR readiness check
      </a>
      <a
        class="button ghost"
        href="https://github.com/ethotechnics/et3/blob/main/docs/diagnostics-outputs.md#server-side-rendering-check"
        aria-label="Review an example SSR diagnostics output"
      >
        See SSR output example
      </a>
    </div>
    <div id="runtime-snapshot" class="panel panel--glass">
      <DiagnosticsSnapshot
        client:load
        initialSnapshot={initialSnapshot}
        refreshUrl="/diagnostics/ssr.json"
        intervalMs={15000}
      />
    </div>
  </section>

  <section class="section section--alt">
    <div class="callout">
      <h3>Why this page exists</h3>
      <p class="muted">
        The site runs with Astro's server output on Cloudflare Workers. This check proves hydration-free SSR paths are
        working and that responses are not cached across requests.
      </p>
      <p class="muted">
        For integration testing, assert that the timestamp and request ID change on refresh and that headers match the
        client or proxy making the request.
      </p>
      <a class="button ghost" href="/diagnostics">Back to diagnostics</a>
    </div>
  </section>
</BaseLayout>
