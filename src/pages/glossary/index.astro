---
import { getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import CardGrid from "../../components/CardGrid.astro";
import CardItem from "../../components/CardItem.astro";
import CitationBlock from "../../components/CitationBlock.astro";
import PageIntro from "../../components/PageIntro.astro";
import ScholarlyMeta from "../../components/ScholarlyMeta.astro";
import SectionBlock from "../../components/SectionBlock.astro";
import SummaryCallout from "../../components/SummaryCallout.astro";
import glossaryFilterScript from "../../scripts/glossary-filter.ts?url";
import { glossaryEntryPermalink } from "../../utils/glossary";
import {
  buildGlossaryEntrySearchText,
  getGlossaryAuthor,
  getGlossaryEntryDefaults,
  normalizeGlossaryHeading,
  stripHtml,
} from "../../utils/glossary-helpers";

const glossaryEntry = (await getEntry("glossary", "glossary"))!;
const libraryEntry = (await getEntry("library", "library"))!;

const {
  pageTitle,
  pageDescription,
  permalink,
  publication,
  territoryMap,
  categories,
  starterTerms,
  categoryHighlights,
} = glossaryEntry.data;
const libraryContent = libraryEntry.data;
const { cspNonce } = Astro.locals;

const patternIndex = new Map(
  libraryContent.patterns.entries.map((pattern) => [pattern.slug, pattern]),
);
const patternFilterLabels = Object.fromEntries(
  libraryContent.patterns.filters.map((filter) => [filter.slug, filter.label]),
);
type GlossaryRelatedPattern = {
  title: string;
  href: string;
  filterLabels: string[];
};
const anchorLinks = [
  { href: "#glossary-pathways", label: "Glossary pathways" },
  { href: "#glossary-index", label: "A–Z index" },
  { href: "#explainer-links", label: "Explainers" },
  { href: "#territory-map", label: "Territory map" },
  ...categories.map((category) => ({
    href: `#${category.id}`,
    label: category.heading,
  })),
];
const summaryLinks = [
  { href: "#starter-terms", label: "Starter terms" },
  { href: "#glossary-pathways", label: "Glossary pathways" },
  { href: "#explainer-links", label: "Explainers" },
  { href: "#glossary-index", label: "A–Z index" },
  { href: "#territory-map", label: "Territory map" },
];
const summaryRelatedLinks = [
  { href: "/mechanisms", label: "Mechanisms" },
  { href: "/standards", label: "Standards" },
  { href: "/research", label: "Research" },
];
const summaryTakeaways = [
  "Every term links to a permalink so citations stay stable.",
  "Territory maps cluster definitions for faster scanning.",
  "Related mechanisms connect definitions to implementation work.",
];

const entryLabelIndex = new Map(
  categories.flatMap((category) =>
    category.entries.map((entry) => [entry.id, entry.title] as const),
  ),
);
const domainFilters = [
  { id: "temporal", label: "Temporal" },
  { id: "visibility", label: "Visibility" },
  { id: "agency", label: "Agency" },
  { id: "burden", label: "Burden" },
  { id: "patterns", label: "Patterns" },
  { id: "measurable", label: "Measurable" },
  { id: "structural", label: "Structural" },
  { id: "diagnostic", label: "Diagnostic" },
];
const phaseFilters = [
  { id: "design", label: "Design" },
  { id: "deployment", label: "Deployment" },
  { id: "audit", label: "Audit" },
  { id: "repair", label: "Repair" },
];
const measurabilityFilters = [
  { id: "qualitative", label: "Qualitative" },
  { id: "semi_quantitative", label: "Semi-quantitative" },
  { id: "fully_measurable", label: "Fully measurable" },
];
const statusFilters = Array.from(
  new Set(
    categories
      .flatMap((category) => category.entries.map((entry) => entry.status))
      .filter((status): status is string => Boolean(status)),
  ),
).sort((a, b) => a.localeCompare(b, "en", { sensitivity: "base" }));

const entryIndex = categories
  .flatMap((category) => {
    const categoryLabel = normalizeGlossaryHeading(category.heading);

    return category.entries.map((entry) => {
      const searchText = buildGlossaryEntrySearchText(entry, categoryLabel);

      return {
        id: entry.id,
        title: entry.title,
        status: entry.status,
        tags: entry.tags ?? [],
        domains: entry.domains ?? [],
        phases: entry.phase ?? [],
        measurability: entry.measurability ?? "",
        maturity: entry.maturity ?? "",
        scale: entry.scale ?? "",
        categoryLabel,
        categoryId: category.id,
        searchText,
      };
    });
  })
  .sort((a, b) =>
    a.title.localeCompare(b.title, "en", { sensitivity: "base" }),
  );
const glossarySuggestions = entryIndex.map((entry) => entry.title);

const territoryCounts = new Map(
  categories.map((category) => [category.id, category.entries.length]),
);
const siteBase = Astro.site ? Astro.site.toString() : Astro.url.origin;
const organizationId = `${siteBase}#organization`;
const websiteId = `${siteBase}#website`;
const pageUrl = Astro.site
  ? new URL(permalink, Astro.site).toString()
  : permalink;
const glossaryEntryUrl = (slug: string) =>
  Astro.site
    ? new URL(glossaryEntryPermalink(slug), Astro.site).toString()
    : glossaryEntryPermalink(slug);
const explainerLinks = [
  {
    title: "Stoppability",
    description: "Learn how halt controls protect people from forced tunnels.",
    href: "/explainers/stoppability",
    glossaryHref: glossaryEntryUrl("stoppability"),
  },
  {
    title: "Time-to-Halt (TTH)",
    description: "Define the latency budget for stopping automated actions.",
    href: "/explainers/time-to-halt",
    glossaryHref: glossaryEntryUrl("time-to-halt"),
  },
  {
    title: "Ethical Interrupts",
    description:
      "Pause automation at risk thresholds with accountable checkpoints.",
    href: "/explainers/ethical-interrupts",
    glossaryHref: glossaryEntryUrl("ethical-interrupts"),
  },
  {
    title: "Consent Journey",
    description: "Map consent across onboarding, renewal, and revocation.",
    href: "/explainers/consent-journey",
    glossaryHref: glossaryEntryUrl("consent-journey"),
  },
  {
    title: "Safety Valve",
    description: "Build fallbacks that release pressure without harm.",
    href: "/explainers/safety-valve",
    glossaryHref: glossaryEntryUrl("safety-valve"),
  },
  {
    title: "Repair Log",
    description: "Track remediation actions with receipts and owners.",
    href: "/explainers/repair-log",
    glossaryHref: glossaryEntryUrl("repair-log"),
  },
  {
    title: "Contestability",
    description: "Ensure people can challenge and reverse automated decisions.",
    href: "/explainers/contestability",
    glossaryHref: glossaryEntryUrl("contestability"),
  },
  {
    title: "Design Authority",
    description: "Assign accountable owners with governance power.",
    href: "/explainers/design-authority",
    glossaryHref: glossaryEntryUrl("design-authority"),
  },
  {
    title: "Burden Index",
    description: "Quantify the time tax systems impose on people.",
    href: "/explainers/burden-index",
    glossaryHref: glossaryEntryUrl("burden-index"),
  },
  {
    title: "Permission Surface",
    description: "Map every permission and access point over time.",
    href: "/explainers/permission-surface",
    glossaryHref: glossaryEntryUrl("permission-surface"),
  },
];
const glossaryPathways = [
  {
    title: "Ethical technology standards",
    description:
      "Use glossary definitions when drafting AI governance requirements, accountability checkpoints, and consent safeguards.",
    href: "/standards",
    linkLabel: "Explore ethical technology standards",
  },
  {
    title: "Human-centered design research",
    description:
      "Pair field research and diagnostics with stable terminology for human-centered design and moral system reviews.",
    href: "/research",
    linkLabel: "Browse human-centered design research",
  },
  {
    title: "Mechanisms and controls library",
    description:
      "Jump from glossary terms to implementation mechanisms like stoppability, safety valves, and contestability patterns.",
    href: "/mechanisms",
    linkLabel: "Review AI governance mechanisms",
  },
  {
    title: "Field notes and practice briefs",
    description:
      "Trace how glossary anchors show up in real-world audits, incident reviews, and remediation playbooks.",
    href: "/field-notes",
    linkLabel: "Read ethical tech field notes",
  },
];
const searchQuery = Astro.url.searchParams.get("query")?.trim() ?? "";
const normalizedQuery = searchQuery.toLowerCase();
const hasSearchQuery = normalizedQuery.length > 0;
const filteredEntries = hasSearchQuery
  ? entryIndex.filter((entry) => entry.searchText.includes(normalizedQuery))
  : entryIndex;
const totalEntries = entryIndex.length;
const visibleEntries = filteredEntries.length;

const structuredEntries = categories.flatMap((category) =>
  category.entries.map((entry) => {
    const plainDescription = stripHtml(entry.bodyHtml);

    return {
      "@type": "DefinedTerm",
      name: entry.title,
      url: glossaryEntryUrl(entry.id),
      inDefinedTermSet: pageUrl,
      description: plainDescription,
    };
  }),
);

const homeUrl = Astro.site ? new URL("/", Astro.site).toString() : "/";
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "CollectionPage",
      "@id": pageUrl,
      name: pageTitle,
      description: pageDescription,
      keywords: [
        "ethical technology glossary",
        "AI governance terms",
        "human-centered design definitions",
        "algorithmic accountability vocabulary",
        "consent and safety terminology",
        "stewardship glossary",
      ],
      url: pageUrl,
      isPartOf: {
        "@id": websiteId,
      },
      publisher: {
        "@id": organizationId,
      },
      mainEntity: {
        "@id": `${pageUrl}#defined-term-set`,
      },
    },
    {
      "@type": "DefinedTermSet",
      "@id": `${pageUrl}#defined-term-set`,
      name: pageTitle,
      description: pageDescription,
      url: pageUrl,
      hasDefinedTerm: structuredEntries,
      potentialAction: {
        "@type": "SearchAction",
        target: `${pageUrl}?query={search_term_string}`,
        "query-input": "required name=search_term_string",
      },
    },
    {
      "@type": "BreadcrumbList",
      itemListElement: [
        {
          "@type": "ListItem",
          position: 1,
          name: "Home",
          item: homeUrl,
        },
        {
          "@type": "ListItem",
          position: 2,
          name: "Glossary",
          item: pageUrl,
        },
      ],
    },
  ],
};
const structuredDataJson = JSON.stringify(structuredData, null, 2);
const citationYear = new Date(
  publication.updated ?? publication.published,
).getFullYear();
const glossaryAuthor = getGlossaryAuthor(publication);
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  enableGlossaryHighlights={false}
>
  <PageIntro
    eyebrow="Glossary"
    title="Ethotechnics glossary"
    description={pageDescription}
    permalink={permalink}
    anchorLinks={anchorLinks}
    panelCopy={{
      eyebrow: "Using the glossary",
      title: "Stable anchors for Ethotechnic language.",
      description:
        "Each term is a mechanism card with related mechanism specs and ready-to-copy citations. Use the permalinks to keep reports, diagnostics, and briefs aligned on exact definitions.",
    }}
  />
  <SummaryCallout
    title="Glossary wayfinding at a glance"
    description="Use this index to align language quickly, then jump straight to the sections that match your research or review window."
    takeaways={summaryTakeaways}
    relatedLinks={summaryRelatedLinks}
    jumpLinks={summaryLinks}
  />
  <div class="callout glossary__starter" id="starter-terms">
    <h3>Start with these terms</h3>
    <p class="muted">
      New to the glossary? These anchors provide the shared vocabulary most
      teams cite first.
    </p>
    <ul class="glossary__starter-list">
      {
        starterTerms.map((term) => (
          <li>
            <a href={glossaryEntryUrl(term.id)}>{term.label}</a>
            <p class="muted small">{term.description}</p>
          </li>
        ))
      }
    </ul>
  </div>
  <SectionBlock
    id="glossary-pathways"
    eyebrow="Pathways"
    title="Glossary pathways for ethical technology teams"
    description="Start with shared definitions, then follow the glossary into AI governance standards, research artifacts, and human-centered design mechanisms."
    variant="alt"
  >
    <CardGrid className="grid--two">
      {
        glossaryPathways.map((pathway) => (
          <CardItem title={pathway.title} description={pathway.description}>
            <p slot="footer">
              <a class="button ghost button--compact" href={pathway.href}>
                {pathway.linkLabel}
              </a>
            </p>
          </CardItem>
        ))
      }
    </CardGrid>
  </SectionBlock>
  <ScholarlyMeta publication={publication} permalink={permalink} />
  <CitationBlock
    title={pageTitle}
    permalink={permalink}
    publication={publication}
    variant="compact"
  />
  <div class="glossary-filter">
    <div class="glossary-filter__controls">
      <label class="glossary-filter__label" for="glossary-filter">
        <span class="visually-hidden">Filter glossary terms</span>
        <input
          id="glossary-filter"
          name="query"
          type="search"
          inputmode="search"
          placeholder="Filter terms (e.g., consent)"
          autocomplete="off"
          list="glossary-filter-suggestions"
          value={searchQuery}
        />
      </label>
      <div class="glossary-filter__tabs" role="tablist">
        <button
          class="glossary-filter__tab is-active"
          type="button"
          role="tab"
          aria-selected="true"
          data-glossary-tab="all"
        >
          All entries <span data-glossary-total>{totalEntries}</span>
        </button>
        <button
          class="glossary-filter__tab"
          type="button"
          role="tab"
          aria-selected="false"
          data-glossary-tab="domains"
        >
          By Domain
        </button>
        <button
          class="glossary-filter__tab"
          type="button"
          role="tab"
          aria-selected="false"
          data-glossary-tab="phases"
        >
          By Phase
        </button>
        <button
          class="glossary-filter__tab"
          type="button"
          role="tab"
          aria-selected="false"
          data-glossary-tab="measurability"
        >
          By Measurability
        </button>
      </div>
    </div>
    <div class="glossary-filter__panels">
      <div
        class="glossary-filter__panel"
        role="tabpanel"
        data-glossary-panel="all"
      >
        <p class="muted">Currently viewing: All entries</p>
      </div>
      <fieldset
        class="glossary-filter__panel"
        role="tabpanel"
        data-glossary-panel="domains"
        hidden
      >
        <legend>Filter by domain</legend>
        <div class="glossary-filter__chips">
          {domainFilters.map((domain) => (
            <label class="glossary-filter__chip">
              <input
                type="checkbox"
                value={domain.id}
                data-glossary-filter="domains"
                data-glossary-label={domain.label}
              />
              <span class="glossary-filter__chip-label">{domain.label}</span>
              <span class="glossary-filter__chip-count" data-glossary-count />
            </label>
          ))}
        </div>
      </fieldset>
      <fieldset
        class="glossary-filter__panel"
        role="tabpanel"
        data-glossary-panel="phases"
        hidden
      >
        <legend>Filter by phase</legend>
        <div class="glossary-filter__chips">
          {phaseFilters.map((phase) => (
            <label class="glossary-filter__chip">
              <input
                type="checkbox"
                value={phase.id}
                data-glossary-filter="phases"
                data-glossary-label={phase.label}
              />
              <span class="glossary-filter__chip-label">{phase.label}</span>
              <span class="glossary-filter__chip-count" data-glossary-count />
            </label>
          ))}
        </div>
      </fieldset>
      <fieldset
        class="glossary-filter__panel"
        role="tabpanel"
        data-glossary-panel="measurability"
        hidden
      >
        <legend>Filter by measurability</legend>
        <div class="glossary-filter__chips">
          {measurabilityFilters.map((option) => (
            <label class="glossary-filter__chip">
              <input
                type="checkbox"
                value={option.id}
                data-glossary-filter="measurability"
                data-glossary-label={option.label}
              />
              <span class="glossary-filter__chip-label">
                {option.label}
              </span>
              <span class="glossary-filter__chip-count" data-glossary-count />
            </label>
          ))}
        </div>
      </fieldset>
      {statusFilters.length > 0 && (
        <fieldset
          class="glossary-filter__panel glossary-filter__panel--status"
          role="tabpanel"
          data-glossary-panel="status"
        >
          <legend>Filter by status</legend>
          <div class="glossary-filter__chips">
            {statusFilters.map((status) => (
              <label class="glossary-filter__chip">
                <input
                  type="checkbox"
                  value={status}
                  data-glossary-filter="status"
                  data-glossary-label={status}
                />
                <span class="glossary-filter__chip-label">{status}</span>
                <span class="glossary-filter__chip-count" data-glossary-count />
              </label>
            ))}
          </div>
        </fieldset>
      )}
    </div>
    <div class="glossary-filter__active" data-glossary-active hidden>
      <p class="muted">Active filters:</p>
      <div class="glossary-filter__active-chips"></div>
    </div>
    <div class="glossary-filter__actions">
      <button
        class="button ghost button--compact glossary-filter__clear"
        type="button"
        data-clear-filter
      >
        Clear filter
      </button>
      <button
        class="button ghost button--compact"
        type="button"
        data-glossary-expand
      >
        Expand sections
      </button>
      <button
        class="button ghost button--compact"
        type="button"
        data-glossary-collapse
      >
        Collapse sections
      </button>
    </div>
    <p class="muted glossary-filter__hint">
      Search across all terms or narrow by domain, phase, or measurability.
    </p>
    <p
      class="muted glossary-filter__count"
      aria-live="polite"
      aria-atomic="true"
      data-total={totalEntries}
    >
      Showing {visibleEntries} of {totalEntries} terms
      {hasSearchQuery && ` for “${searchQuery}”`}
    </p>
    <p class="muted glossary-index__empty" hidden={visibleEntries > 0}>
      No entries match that search or filter. Try another keyword or browse the
      territory map for nearby concepts.
    </p>
  </div>
  <datalist id="glossary-filter-suggestions">
    {glossarySuggestions.map((suggestion) => <option value={suggestion} />)}
  </datalist>
  <SectionBlock
    id="explainer-links"
    eyebrow="Explainers"
    title="High-intent glossary explainers"
    description="Short, reusable definitions with examples and next-step artifacts."
    variant="alt"
  >
    <CardGrid className="grid--three">
      {
        explainerLinks.map((explainer) => (
          <CardItem title={explainer.title} description={explainer.description}>
            <p slot="footer">
              <a class="button ghost button--compact" href={explainer.href}>
                Read explainer
              </a>
              <span class="muted">
                {" "}
                • <a href={explainer.glossaryHref}>Glossary entry</a>
              </span>
            </p>
          </CardItem>
        ))
      }
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="glossary-index"
    eyebrow="Index"
    title="A–Z of Ethotechnic terms"
    description={`Alphabetical list with ${entryIndex.length} definitions ready to link directly.`}
  >
    <div class="glossary-index" role="navigation" aria-label="Glossary index">
      {
        entryIndex.map((entry) => {
          const matchesQuery = entry.searchText.includes(normalizedQuery);
          const entryClasses = [
            "glossary-index__item",
            ...(hasSearchQuery && !matchesQuery ? ["is-hidden"] : []),
          ].join(" ");

          return (
            <a
              class={entryClasses}
              href={glossaryEntryUrl(entry.id)}
              data-glossary-entry-link
              data-title={entry.title}
              data-category={entry.categoryLabel}
              data-category-id={entry.categoryId}
              data-tags={entry.tags.join(" ")}
              data-domains={entry.domains.join(" ")}
              data-phases={entry.phases.join(" ")}
              data-measurability={entry.measurability}
              data-maturity={entry.maturity}
              data-scale={entry.scale}
              data-status={entry.status ?? ""}
              data-search={entry.searchText}
            >
              <span class="glossary-index__term">{entry.title}</span>
              <span class="muted glossary-index__category">
                {entry.categoryLabel}
              </span>
            </a>
          );
        })
      }
    </div>
    <p class="glossary__cta muted">Index links jump to canonical permalinks.</p>
  </SectionBlock>

  <SectionBlock
    id="territory-map"
    eyebrow="Map"
    title="Territory map"
    description="Browse glossary areas with entry counts."
    variant="alt"
  >
    <details>
      <summary>Open the territory map</summary>
      <div class="glossary__categories">
        {
          categoryHighlights.map((category) => (
            <article class="glossary__category">
              <h3>{category.label}</h3>
              <p class="muted">{category.description}</p>
              <a class="button ghost button--compact" href={`#${category.id}`}>
                Jump to {category.label}
              </a>
            </article>
          ))
        }
      </div>
      <div class="territory-map">
        {
          territoryMap.map((item) => (
            <article class="territory-map__item" id={`territory-${item.id}`}>
              <a
                class="territory-map__link"
                href={`#${item.id}`}
                aria-labelledby={`territory-${item.id}-title`}
                aria-describedby={`territory-${item.id}-description territory-${item.id}-count`}
              >
                <h3 id={`territory-${item.id}-title`}>{item.label}</h3>
                <p id={`territory-${item.id}-description`} class="muted">
                  {item.tooltip}
                </p>
                <p
                  id={`territory-${item.id}-count`}
                  class="glossary-territory__count"
                >
                  {territoryCounts.get(item.id) ?? 0} entries
                </p>
              </a>
            </article>
          ))
        }
      </div>
    </details>
  </SectionBlock>

  {
    categories.map((category, index) => (
      <SectionBlock
        id={category.id}
        eyebrow={`Section ${String.fromCharCode(65 + index)}`}
        title={category.heading}
        description={
          category.comingSoon ? "Definitions in progress." : undefined
        }
        variant={index % 2 === 0 ? "default" : "alt"}
        className="glossary-section"
      >
        <details
          class="chunked-section"
          open={index === 0}
          data-default-open={index === 0}
        >
          <summary class="chunked-section__summary">
            {category.heading} entries ({category.entries.length})
          </summary>
          <div class="chunked-section__body">
            <div
              class="glossary-section__description"
              set:html={category.descriptionHtml}
            />
            <div class="glossary-grid">
              {category.entries.map((entry) => {
                const entryClasses = [
                  "glossary-entry",
                  ...(entry.classes ?? []),
                ].join(" ");
                const entryUrl = glossaryEntryUrl(entry.id);
                const citationApa = `${glossaryAuthor}. (${citationYear}). ${entry.title}. In Ethotechnics glossary. ${entryUrl}`;
                const citationMla = `${glossaryAuthor}. "${entry.title}." Ethotechnics glossary, ${citationYear}, ${entryUrl}.`;
                const citationChicago = `${glossaryAuthor}. "${entry.title}." Ethotechnics glossary. ${citationYear}. ${entryUrl}.`;
                const citationBibtex = `@misc{ethotechnics_${entry.id}_${citationYear}, title={${entry.title}}, author={${glossaryAuthor}}, year={${citationYear}}, howpublished={Ethotechnics glossary}, url={${entryUrl}}}`;
                const citationRis = [
                  "TY  - WEB",
                  `TI  - ${entry.title}`,
                  ...publication.authors.map(
                    (author) => `AU  - ${author.name}`,
                  ),
                  `PY  - ${citationYear}`,
                  `UR  - ${entryUrl}`,
                  "ER  -",
                ].join("\n");
                const {
                  scopeText,
                  adjacentTerms,
                  operationalTests,
                  commonCounterfeits,
                  genealogy,
                  references,
                } = getGlossaryEntryDefaults(entry, category);
                const relatedPatterns: GlossaryRelatedPattern[] = (
                  entry.relatedPatterns ?? []
                )
                  .map((slug) => {
                    const pattern = patternIndex.get(slug);

                    if (!pattern) {
                      return null;
                    }

                    return {
                      title: pattern.title,
                      href: `/mechanisms/patterns/${pattern.slug}`,
                      filterLabels: pattern.filters.map(
                        (filter) => patternFilterLabels[filter] ?? filter,
                      ),
                    } satisfies GlossaryRelatedPattern;
                  })
                  .filter((pattern): pattern is GlossaryRelatedPattern =>
                    Boolean(pattern),
                  );
                return (
                  <article
                    id={entry.id}
                    class={entryClasses}
                    itemscope
                    itemtype="https://schema.org/DefinedTerm"
                  >
                    <meta itemprop="url" content={entryUrl} />
                    <meta itemprop="inDefinedTermSet" content={permalink} />
                    <header class="glossary-entry__header">
                      <div>
                        <p class="eyebrow">Glossary term</p>
                        <h3 itemprop="name">{entry.title}</h3>
                      </div>
                      <div class="glossary-entry__actions">
                        <a
                          class="glossary-entry__permalink"
                          href={entryUrl}
                          data-glossary-entry-link
                          aria-label={`Permalink to ${entry.title}`}
                          rel="bookmark"
                          itemprop="mainEntityOfPage"
                        >
                          Permalink
                        </a>
                        <div
                          class="glossary-entry__citation-buttons"
                          aria-label={`Copy citation for ${entry.title}`}
                        >
                          <button
                            class="copy-button"
                            type="button"
                            data-citation-text={citationApa}
                            data-citation-format="apa"
                            aria-label={`Copy APA citation for ${entry.title}`}
                          >
                            Copy citation (APA)
                          </button>
                          <button
                            class="copy-button"
                            type="button"
                            data-citation-text={citationMla}
                            data-citation-format="mla"
                            aria-label={`Copy MLA citation for ${entry.title}`}
                          >
                            Copy MLA
                          </button>
                          <button
                            class="copy-button"
                            type="button"
                            data-citation-text={citationChicago}
                            data-citation-format="chicago"
                            aria-label={`Copy Chicago citation for ${entry.title}`}
                          >
                            Copy Chicago
                          </button>
                          <button
                            class="copy-button"
                            type="button"
                            data-citation-text={citationBibtex}
                            data-citation-format="bibtex"
                            aria-label={`Copy BibTeX citation for ${entry.title}`}
                          >
                            Copy citation (BibTeX)
                          </button>
                          <button
                            class="copy-button"
                            type="button"
                            data-citation-text={citationRis}
                            data-citation-format="ris"
                            aria-label={`Copy RIS citation for ${entry.title}`}
                          >
                            Copy RIS
                          </button>
                        </div>
                      </div>
                    </header>
                    <div class="glossary-entry__block">
                      <p class="eyebrow">Definition</p>
                      <div
                        class="glossary-entry__body"
                        set:html={entry.bodyHtml}
                        itemprop="description"
                      />
                    </div>
                    {scopeText && (
                      <div class="glossary-entry__block">
                        <p class="eyebrow">Scope</p>
                        <p class="muted">{scopeText}</p>
                      </div>
                    )}
                    {adjacentTerms.length > 0 && (
                      <div class="glossary-entry__block">
                        <p class="eyebrow">Adjacent terms</p>
                        <div class="pill-row">
                          {adjacentTerms.map((term) => (
                            <a
                              class="pill pill--muted"
                              href={glossaryEntryUrl(term)}
                              itemprop="keywords"
                            >
                              {entryLabelIndex.get(term) ?? term}
                            </a>
                          ))}
                        </div>
                      </div>
                    )}
                    {operationalTests.length > 0 && (
                      <div class="glossary-entry__block">
                        <p class="eyebrow">Operational tests</p>
                        <ul class="muted">
                          {operationalTests.map((test) => (
                            <li>{test}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    {commonCounterfeits.length > 0 && (
                      <div class="glossary-entry__block">
                        <p class="eyebrow">Common counterfeits</p>
                        <ul class="muted">
                          {commonCounterfeits.map((counterfeit) => (
                            <li>{counterfeit}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    {genealogy && (
                      <div class="glossary-entry__block">
                        <p class="eyebrow">Genealogy</p>
                        <p class="muted">{genealogy}</p>
                      </div>
                    )}
                    {relatedPatterns.length > 0 && (
                      <div class="glossary-entry__block glossary-entry__block--patterns">
                        <p class="eyebrow">Related mechanisms</p>
                        <ul class="glossary-entry__patterns-list">
                          {relatedPatterns.map((relatedPattern) => (
                            <li class="glossary-entry__pattern-card">
                              <a
                                class="glossary-entry__pattern-link"
                                href={relatedPattern.href}
                              >
                                <span class="glossary-entry__pattern-title">
                                  {relatedPattern.title}
                                </span>
                                <span class="muted small">
                                  {relatedPattern.filterLabels.join(", ")}
                                </span>
                              </a>
                            </li>
                          ))}
                        </ul>
                        <p class="muted small glossary-entry__patterns-hint">
                          See the full mechanisms catalog.
                        </p>
                      </div>
                    )}
                    {entry.examples && entry.examples.length > 0 && (
                      <div class="glossary-entry__block">
                        <p class="eyebrow">Example corpus</p>
                        <ul class="muted">
                          {entry.examples.map((example) => (
                            <li>{example}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    {references.length > 0 && (
                      <div class="glossary-entry__block">
                        <p class="eyebrow">References</p>
                        <ul class="muted glossary-entry__resources">
                          {references.map((resource) => (
                            <li>
                              <a href={resource.href}>{resource.label}</a>
                              {resource.type && (
                                <span class="muted"> · {resource.type}</span>
                              )}
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </article>
                );
              })}
            </div>
          </div>
        </details>
      </SectionBlock>
    ))
  }

  <script
    type="application/ld+json"
    nonce={cspNonce}
    set:html={structuredDataJson}
    is:inline
  />
  <script type="module" src={glossaryFilterScript} is:inline></script>
</BaseLayout>
