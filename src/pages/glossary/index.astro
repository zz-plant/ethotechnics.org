---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageIntro from '../../components/PageIntro.astro';
import SectionBlock from '../../components/SectionBlock.astro';
import { glossaryContent } from '../../content/glossary';
import glossaryFilterScript from '../../scripts/glossary-filter.ts?url';

const { pageTitle, pageDescription, permalink, territoryMap, categories } = glossaryContent;
const anchorLinks = [
  { href: '#glossary-index', label: 'A–Z index' },
  { href: '#territory-map', label: 'Territory map' },
  ...categories.map((category) => ({ href: `#${category.id}`, label: category.heading })),
];

const entryIndex = categories
  .flatMap((category) =>
    category.entries.map((entry) => ({
      id: entry.id,
      title: entry.title,
      categoryLabel: category.heading.replace(/^[A-Z]\.\s*/, ''),
    })),
  )
  .sort((a, b) => a.title.localeCompare(b.title, 'en', { sensitivity: 'base' }));

const territoryCounts = new Map(categories.map((category) => [category.id, category.entries.length]));
---
<BaseLayout title={pageTitle} description={pageDescription}>
  <PageIntro
    eyebrow="Glossary"
    title="Ethotechnics glossary"
    description={pageDescription}
    permalink={permalink}
    anchorLinks={anchorLinks}
    panelCopy={{
      eyebrow: 'Using the glossary',
      title: 'Stable anchors for Ethotechnic language.',
      description:
        'Use the permalinks to keep reports, diagnostics, and briefs aligned on exact definitions. Scan the A–Z index or jump by territory to land on the right concept fast.',
    }}
  />

  <SectionBlock
    id="glossary-index"
    eyebrow="Index"
    title="A–Z of Ethotechnic terms"
    description={`Alphabetical list with ${entryIndex.length} definitions ready to link directly.`}
  >
    <div class="glossary-filter">
      <label class="glossary-filter__label" for="glossary-filter">
        <span class="visually-hidden">Filter glossary terms</span>
        <input
          id="glossary-filter"
          name="glossary-filter"
          type="search"
          inputmode="search"
          placeholder="Start typing to narrow the index (e.g., consent)"
          autocomplete="off"
        />
      </label>
      <p class="muted glossary-filter__hint">
        Keep typing to filter the list, then open a matching term to grab its permalink or scan nearby entries.
      </p>
      <p class="muted glossary-filter__count" aria-live="polite" aria-atomic="true">
        Showing {entryIndex.length} of {entryIndex.length} terms
      </p>
    </div>
    <div class="glossary-index" role="navigation" aria-label="Glossary index">
      {entryIndex.map((entry) => (
        <a
          class="glossary-index__item"
          href={`${permalink}#${entry.id}`}
          data-title={entry.title}
          data-category={entry.categoryLabel}
        >
          <span class="glossary-index__term">{entry.title}</span>
          <span class="muted glossary-index__category">{entry.categoryLabel}</span>
        </a>
      ))}
    </div>
    <p class="muted glossary-index__empty" hidden>
      No matching terms yet. Try a broader keyword or open the territory map below to scan by topic.
    </p>
    <p class="glossary__cta muted">
      Each index link jumps to the canonical permalink so research notes and diagnostics share the same language.
    </p>
  </SectionBlock>

  <SectionBlock
    id="territory-map"
    eyebrow="Map"
    title="Territory map"
    description="Quick scan of glossary areas with entry counts to help you jump to the right section."
    variant="alt"
  >
    <div class="territory-map">
      {territoryMap.map((item) => (
        <article class="territory-map__item" id={`territory-${item.id}`}>
          <a
            class="territory-map__link"
            href={`#${item.id}`}
            aria-labelledby={`territory-${item.id}-title`}
            aria-describedby={`territory-${item.id}-description territory-${item.id}-count`}
          >
            <h3 id={`territory-${item.id}-title`}>{item.label}</h3>
            <p id={`territory-${item.id}-description`} class="muted">
              {item.tooltip}
            </p>
            <p id={`territory-${item.id}-count`} class="glossary-territory__count">
              {territoryCounts.get(item.id) ?? 0} entries
            </p>
          </a>
        </article>
      ))}
    </div>
  </SectionBlock>

  {categories.map((category, index) => (
    <SectionBlock
      id={category.id}
      eyebrow={`Section ${String.fromCharCode(65 + index)}`}
      title={category.heading}
      description={category.comingSoon ? 'Definitions in progress.' : undefined}
      variant={index % 2 === 0 ? 'default' : 'alt'}
      className="glossary-section"
    >
      <div class="glossary-section__description" set:html={category.descriptionHtml} />
      <div class="glossary-grid">
        {category.entries.map((entry) => {
          const entryClasses = ['glossary-entry', ...(entry.classes ?? [])].join(' ');
          return (
            <article
              id={entry.id}
              class={entryClasses}
              itemscope
              itemtype="https://schema.org/DefinedTerm"
            >
              <meta itemprop="url" content={`${permalink}#${entry.id}`} />
              <meta itemprop="inDefinedTermSet" content={permalink} />
              <header class="glossary-entry__header">
                <div>
                  <p class="eyebrow">Glossary term</p>
                  <h3 itemprop="name">{entry.title}</h3>
                </div>
                <a
                  class="glossary-entry__permalink"
                  href={`${permalink}#${entry.id}`}
                  aria-label={`Permalink to ${entry.title}`}
                  rel="bookmark"
                  itemprop="mainEntityOfPage"
                >
                  Permalink
                </a>
              </header>
              <div class="glossary-entry__body" set:html={entry.bodyHtml} itemprop="description" />
              {entry.examples && entry.examples.length > 0 && (
                <div class="glossary-entry__block">
                  <p class="eyebrow">Examples</p>
                  <ul class="muted">
                    {entry.examples.map((example) => (
                      <li>{example}</li>
                    ))}
                  </ul>
                </div>
              )}
              {entry.tags && entry.tags.length > 0 && (
                <div class="glossary-entry__block">
                  <p class="eyebrow">Tags</p>
                  <div class="pill-row">
                    {entry.tags.map((tag) => (
                      <span class="pill pill--muted" itemprop="keywords">{tag}</span>
                    ))}
                  </div>
                </div>
              )}
              {entry.resources && entry.resources.length > 0 && (
                <div class="glossary-entry__block">
                  <p class="eyebrow">Resources</p>
                  <ul class="muted glossary-entry__resources">
                    {entry.resources.map((resource) => (
                      <li>
                        <a href={resource.href}>{resource.label}</a>
                        {resource.type && <span class="muted"> · {resource.type}</span>}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </article>
          );
        })}
      </div>
    </SectionBlock>
  ))}

  <script type="module" src={glossaryFilterScript}></script>
</BaseLayout>
