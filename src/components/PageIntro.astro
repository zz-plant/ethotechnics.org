---
export interface AnchorLink {
  href: string;
  label: string;
}

export interface PanelCopy {
  eyebrow?: string;
  title: string;
  description: string;
  link?: {
    label: string;
    href: string;
  };
}

export interface Props {
  eyebrow: string;
  title: string;
  titleLevel?: 1 | 2 | 3 | 4 | 5 | 6;
  description: string;
  permalink: string;
  anchorLinks: AnchorLink[];
  panelCopy?: PanelCopy;
}

const {
  eyebrow,
  title,
  titleLevel = 1,
  description,
  permalink,
  anchorLinks,
  panelCopy,
} = Astro.props;
const hasCustomAside = Astro.slots.has("aside");
const hasActions = Astro.slots.has("actions");

const { cspNonce } = Astro.locals;
const siteBase = Astro.site ? Astro.site.toString() : Astro.url.origin;
const normalizedPermalink = permalink?.trim();
const permalinkUrl = normalizedPermalink
  ? new URL(normalizedPermalink, siteBase)
  : null;
const abbreviatedPermalink = permalinkUrl
  ? `${permalinkUrl.pathname}${permalinkUrl.hash}`
  : normalizedPermalink;
const breadcrumbItems = normalizedPermalink
  ? buildBreadcrumbItems(normalizedPermalink, siteBase, title)
  : [];
const breadcrumbJson =
  breadcrumbItems.length > 0
    ? JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'BreadcrumbList',
        itemListElement: breadcrumbItems,
      })
    : null;

const HeadingTag = `h${titleLevel}` as const;

function buildBreadcrumbItems(path: string, baseUrl: string, pageTitle: string) {
  const breadcrumbUrl = new URL(path, baseUrl);
  const segments = breadcrumbUrl.pathname.split('/').filter(Boolean);

  if (segments.length === 0) {
    return [];
  }

  const homeItem = {
    '@type': 'ListItem',
    position: 1,
    name: 'Home',
    item: new URL('/', baseUrl).toString(),
  } as const;

  const segmentItems = segments.map((segment, index) => {
    const name = index === segments.length - 1 ? pageTitle : titleize(segment);
    const itemPath = `/${segments.slice(0, index + 1).join('/')}`;

    return {
      '@type': 'ListItem',
      position: index + 2,
      name,
      item: new URL(itemPath, baseUrl).toString(),
    } as const;
  });

  return [homeItem, ...segmentItems];
}

function titleize(segment: string) {
  return segment
    .split('-')
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');
}
---
{breadcrumbJson && (
  <Fragment slot="head">
    <script type="application/ld+json" nonce={cspNonce} set:html={breadcrumbJson} is:inline></script>
  </Fragment>
)}
<section class="section page-intro">
  <div class="page-intro__grid">
    <div class="page-intro__lead">
      {breadcrumbItems.length > 1 && (
        <nav class="page-intro__breadcrumbs" aria-label="Breadcrumb">
          <ol>
            {breadcrumbItems.map((item, index) => (
              <li>
                {index === breadcrumbItems.length - 1 ? (
                  <span aria-current="page">{item.name}</span>
                ) : (
                  <a href={item.item}>{item.name}</a>
                )}
              </li>
            ))}
          </ol>
        </nav>
      )}
      <div class="page-intro__meta">
        <p class="eyebrow">{eyebrow}</p>
        <p class="page-intro__permalink">
          <span class="page-intro__permalink-icon" aria-hidden="true">â†º</span>
          <span class="page-intro__permalink-label">Permanent link</span>
          <a class="page-intro__permalink-path" href={permalink}>
            {abbreviatedPermalink}
          </a>
          <button
            class="copy-button page-intro__permalink-copy"
            type="button"
            data-permalink-copy
            data-copy-value={permalinkUrl?.toString() ?? normalizedPermalink}
            aria-label="Copy permanent link to this page"
          >
            Copy link
          </button>
          <span
            class="page-intro__permalink-status"
            data-permalink-status
            role="status"
            aria-live="polite"
          ></span>
        </p>
      </div>
      <HeadingTag>{title}</HeadingTag>
      <p class="muted page-intro__lede">{description}</p>
      {hasActions && (
        <div class="page-intro__actions section__actions">
          <slot name="actions" />
        </div>
      )}
    </div>

    <div class="page-intro__aside">
      {panelCopy && (
        <div class="panel panel--glass page-intro__panel">
          {panelCopy.eyebrow && <p class="muted">{panelCopy.eyebrow}</p>}
          <h2>{panelCopy.title}</h2>
          <p>{panelCopy.description}</p>
          {panelCopy.link && (
            <p>
              <a href={panelCopy.link.href}>{panelCopy.link.label}</a>
            </p>
          )}
        </div>
      )}

      {hasCustomAside && (
        <div class="page-intro__aside-custom">
          <slot name="aside" />
        </div>
      )}

      {anchorLinks.length > 0 && (
        <nav aria-label="On-page links" class="page-intro__anchors">
          <div>
            <p class="muted">Jump to</p>
            <p class="page-intro__anchors-title">Key sections</p>
          </div>
          <ul>
            {anchorLinks.map((link, index) => (
              <li>
                <a href={link.href} class="pill pill--ghost">
                  <span class="page-intro__anchor-index">{index + 1}</span>
                  <span>{link.label}</span>
                </a>
              </li>
            ))}
          </ul>
        </nav>
      )}
    </div>
  </div>
</section>

<script nonce={cspNonce} is:inline>
  const copyButtons = Array.from(
    document.querySelectorAll("[data-permalink-copy]")
  );

  copyButtons.forEach((button) => {
    const status = button
      .closest(".page-intro__permalink")
      ?.querySelector("[data-permalink-status]");
    const value = button.getAttribute("data-copy-value");

    if (!status || !value) {
      return;
    }

    let resetTimer;

    button.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(value);
        status.textContent = "Copied";
        status.classList.add("is-visible");
      } catch (error) {
        status.textContent = "Copy failed";
        status.classList.add("is-visible");
      }

      clearTimeout(resetTimer);
      resetTimer = window.setTimeout(() => {
        status.textContent = "";
        status.classList.remove("is-visible");
      }, 2000);
    });
  });
</script>
