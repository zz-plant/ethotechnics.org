---
export interface AnchorLink {
  href: string;
  label: string;
}

export interface PanelCopy {
  eyebrow?: string;
  title: string;
  description: string;
  link?: {
    label: string;
    href: string;
  };
}

export interface Props {
  eyebrow: string;
  title: string;
  titleLevel?: 1 | 2 | 3 | 4 | 5 | 6;
  description: string;
  permalink: string;
  anchorLinks: AnchorLink[];
  panelCopy?: PanelCopy;
}

const {
  eyebrow,
  title,
  titleLevel = 1,
  description,
  permalink,
  anchorLinks,
  panelCopy,
} = Astro.props;

const { cspNonce } = Astro.locals;
const siteBase = Astro.site ? Astro.site.toString() : Astro.url.origin;
const normalizedPermalink = permalink?.trim();
const breadcrumbItems = normalizedPermalink
  ? buildBreadcrumbItems(normalizedPermalink, siteBase, title)
  : [];
const breadcrumbJson =
  breadcrumbItems.length > 0
    ? JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'BreadcrumbList',
        itemListElement: breadcrumbItems,
      })
    : null;

const HeadingTag = `h${titleLevel}` as const;

function buildBreadcrumbItems(path: string, baseUrl: string, pageTitle: string) {
  const breadcrumbUrl = new URL(path, baseUrl);
  const segments = breadcrumbUrl.pathname.split('/').filter(Boolean);

  return segments.map((segment, index) => {
    const name = index === segments.length - 1 ? pageTitle : titleize(segment);
    const itemPath = `/${segments.slice(0, index + 1).join('/')}`;

    return {
      '@type': 'ListItem',
      position: index + 1,
      name,
      item: new URL(itemPath, baseUrl).toString(),
    } as const;
  });
}

function titleize(segment: string) {
  return segment
    .split('-')
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');
}
---
{breadcrumbJson && (
  <Fragment slot="head">
    <script type="application/ld+json" nonce={cspNonce} set:html={breadcrumbJson} is:inline></script>
  </Fragment>
)}
<section class="section page-intro">
  <div class="page-intro__grid">
    <div class="page-intro__lead">
      <div class="page-intro__meta">
        <p class="eyebrow">{eyebrow}</p>
        <p class="page-intro__permalink">
          <span aria-hidden="true">â†º</span>
          <span class="page-intro__permalink-label">Permanent link</span>
          <a href={permalink}>{permalink}</a>
        </p>
      </div>
      <HeadingTag>{title}</HeadingTag>
      <p class="muted page-intro__lede">{description}</p>
    </div>

    <div class="page-intro__aside">
      {panelCopy && (
        <div class="panel panel--glass page-intro__panel">
          {panelCopy.eyebrow && <p class="muted">{panelCopy.eyebrow}</p>}
          <h2>{panelCopy.title}</h2>
          <p>{panelCopy.description}</p>
          {panelCopy.link && (
            <p>
              <a href={panelCopy.link.href}>{panelCopy.link.label}</a>
            </p>
          )}
        </div>
      )}

      {anchorLinks.length > 0 && (
        <nav aria-label="On-page links" class="page-intro__anchors">
          <div>
            <p class="muted">Jump to</p>
            <p class="page-intro__anchors-title">Key sections</p>
          </div>
          <ul>
            {anchorLinks.map((link, index) => (
              <li>
                <a href={link.href} class="pill pill--ghost">
                  <span class="page-intro__anchor-index">{index + 1}</span>
                  <span>{link.label}</span>
                </a>
              </li>
            ))}
          </ul>
        </nav>
      )}
    </div>
  </div>
</section>
