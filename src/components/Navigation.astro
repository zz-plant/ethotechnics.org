---
import NavActions from './NavActions.astro';
import NavQuickLinks from './NavQuickLinks.astro';
import NavSectionList from './NavSectionList.astro';
import NavUtilityLinks from './NavUtilityLinks.astro';
import { libraryContent } from '../content/library';
import { navActions, navSections } from '../content/navigation';

interface Props {
  currentPath?: string;
}

const navTags = libraryContent.patterns.filters.map((filter) => ({
  href: `${libraryContent.permalink}#${filter.slug}`,
  label: filter.label,
}));

const { currentPath = Astro.url.pathname } = Astro.props as Props;
const normalizePath = (path: string) => {
  const [clean] = path.split('#');
  if (!clean) return '/';

  const trimmed = clean.endsWith('/') && clean !== '/' ? clean.slice(0, -1) : clean;

  return trimmed || '/';
};
const isHome = normalizePath(currentPath) === '/';
const isCurrentLink = (href: string) => normalizePath(href) === normalizePath(currentPath);

const topLevelLinks = [
  { href: '/library', label: 'Library' },
  { href: '/institute', label: 'Institute' },
  { href: '/diagnostics', label: 'Diagnostics' },
];
---
<nav class="nav" aria-label="Primary" data-astro-transition-persist data-nav>
  <div class="nav__inner container">
    <div class="nav__bar">
      <a
        href="/"
        class="nav__brand"
        aria-label="Go to the homepage"
        aria-current={isHome ? 'page' : undefined}
      >
        Ethotechnics
      </a>

      <div class="nav__links nav__links--desktop" aria-label="Primary">
        {topLevelLinks.map((link) => (
          <a
            class="nav__link"
            href={link.href}
            aria-current={isCurrentLink(link.href) ? 'page' : undefined}
          >
            {link.label}
          </a>
        ))}
      </div>

      <div class="nav__utility nav__utility--desktop">
        <NavUtilityLinks currentPath={currentPath} />
      </div>
    </div>

    <div class="nav__mobile" aria-label="Primary">
      <div class="nav__mobile-row">
        <div class="nav__links nav__links--mobile">
          {topLevelLinks.map((link) => (
            <a
              class="nav__link"
              href={link.href}
              aria-current={isCurrentLink(link.href) ? 'page' : undefined}
            >
              {link.label}
            </a>
          ))}
        </div>

        <div class="nav__utility nav__utility--mobile">
          <NavUtilityLinks currentPath={currentPath} />
        </div>
      </div>
    </div>

    <div class="nav__content">
      <div class="nav__content-body">
        <div class="nav__content-header">
          <div class="nav__content-title">
            <p class="eyebrow">Navigation</p>
            <p class="muted">Find Ethotechnics resources, programs, and diagnostics in one place.</p>
          </div>
          <div class="nav__utility nav__utility--desktop">
            <NavUtilityLinks currentPath={currentPath} />
          </div>
        </div>
        <div class="nav__content-grid">
          <div class="nav__primary">
            <NavSectionList sections={navSections} currentPath={currentPath} />
          </div>
          <div class="nav__secondary">
            <NavQuickLinks links={navTags} />
            <NavActions actions={navActions} />
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>
