---
/**
 * Standard card markup with glow, heading control, pill lists, and optional glossary links.
 *
 * Props:
 * - id: Optional anchor for the card (for deep-linking).
 * - eyebrow: Uppercase label shown above the body.
 * - meta: Muted line placed above the title (e.g., timeframe or type).
 * - title: Card heading text. Omit to use custom slot content instead.
 * - headingLevel: Heading tag to render for the title (defaults to `h3`).
 * - titleId: Optional id for the title, used to connect `aria-labelledby`.
 * - description: Supporting copy, muted by default.
 * - descriptionTone: Set to `default` to render the description without the muted class.
 * - tags: Renders as a `.pill-list` under the description.
 * - tagsClassName: Optional class name appended to the tags list.
 * - glossaryLinks: Array of `{ href, label }` rendered as a "Glossary" line with comma separators.
 * - glossaryLabel: Override the glossary label (defaults to "Glossary").
 * - icon: Optional astro-icon name rendered above the title.
 * - className: Optional class name appended to the card root.
 * - ariaLabel: Optional aria-label for the card root.
 */
import { Icon } from "astro-icon/components";

interface GlossaryLink {
  href: string;
  label: string;
}

interface Props {
  id?: string;
  eyebrow?: string;
  meta?: string;
  icon?: string;
  title?: string;
  headingLevel?: "h2" | "h3" | "h4";
  description?: string;
  descriptionTone?: "default" | "muted";
  titleId?: string;
  tags?: string[];
  tagsClassName?: string;
  glossaryLinks?: GlossaryLink[];
  glossaryLabel?: string;
  dataDelivery?: string;
  className?: string;
  ariaLabel?: string;
}

const props = Astro.props as Props;
const {
  id,
  eyebrow,
  meta,
  icon,
  title,
  headingLevel = "h3",
  description,
  descriptionTone = "muted",
  titleId,
  tags = [],
  tagsClassName,
  glossaryLinks = [],
  glossaryLabel = "Glossary",
  dataDelivery,
  className,
  ariaLabel,
} = props;

const HeadingTag = headingLevel;
const descriptionClass = descriptionTone === "muted" ? "muted" : undefined;
const hasTags = tags.length > 0;
const hasGlossaryLinks = glossaryLinks.length > 0;
const cardClass = ["card", className].filter(Boolean).join(" ");
const tagListClass = ["pill-list", tagsClassName].filter(Boolean).join(" ");
const resolvedTitleId = title
  ? titleId || (id ? `${id}-title` : undefined)
  : undefined;
const labelledBy = ariaLabel ? undefined : resolvedTitleId;
---

<article
  class={cardClass}
  id={id}
  data-delivery={dataDelivery}
  aria-label={ariaLabel}
  aria-labelledby={labelledBy}
>
  <div class="card__glow" aria-hidden="true"></div>
  {eyebrow && <p class="eyebrow">{eyebrow}</p>}
  {meta && <p class="muted">{meta}</p>}
  {
    icon && (
      <div class="icon" aria-hidden="true">
        <Icon name={icon} />
      </div>
    )
  }
  {title && <HeadingTag id={resolvedTitleId}>{title}</HeadingTag>}
  {description && <p class={descriptionClass}>{description}</p>}
  <slot />
  {
    hasTags && (
      <ul class={tagListClass}>
        {tags.map((tag) => (
          <li>{tag}</li>
        ))}
      </ul>
    )
  }
  {
    hasGlossaryLinks && (
      <p class="muted">
        {glossaryLabel}:{" "}
        {glossaryLinks.map((link, index) => {
          const separator = index < glossaryLinks.length - 1 ? ", " : "";

          return (
            <>
              <a href={link.href}>{link.label}</a>
              {separator}
            </>
          );
        })}
      </p>
    )
  }
  <slot name="footer" />
</article>

<style>
  .card {
    position: relative;
    background: color-mix(in srgb, var(--surface) 95%, white 5%);
    border: 1px solid color-mix(in srgb, var(--border) 82%, transparent);
    border-radius: calc(var(--radius) - 2px);
    padding: 1.5rem;
    box-shadow: 0 12px 24px rgba(64, 52, 40, 0.06);
    isolation: isolate;
    overflow: hidden;
    transition:
      transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
      box-shadow 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow:
      0 20px 48px rgba(64, 52, 40, 0.12),
      0 8px 16px rgba(64, 52, 40, 0.04);
    z-index: var(--z-raised);
  }

  /* Apply grain texture if available */
  .card::after {
    content: "";
    position: absolute;
    inset: 0;
    background-image: var(--grain-texture, none);
    opacity: 0.03; /* Subtle grain */
    pointer-events: none;
    z-index: var(--z-underlay);
    mix-blend-mode: multiply;
  }

  .card__glow {
    position: absolute;
    inset: 0;
    background: radial-gradient(
      circle at top left,
      rgba(255, 255, 255, 0.6),
      transparent 60%
    );
    opacity: 0.4;
    pointer-events: none;
    z-index: var(--z-underlay);
    mix-blend-mode: screen;
  }
</style>
