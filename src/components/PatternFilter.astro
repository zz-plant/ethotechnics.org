---
import { randomUUID } from "node:crypto";

import type { Pattern, PatternFilter } from "../content/library";
import {
  getGlossaryDefinition,
  getGlossaryLabel,
  glossaryEntryPermalink,
} from "../utils/glossary";
import patternFilterScript from "../scripts/pattern-filter.ts?url";

type Props = {
  filters: PatternFilter[];
  entries: Pattern[];
  diagnosticTitles: Record<string, string>;
  searchId?: string;
};

const { filters, entries, diagnosticTitles, searchId } = Astro.props as Props;
const filterLabels = Object.fromEntries(
  filters.map((filter) => [filter.slug, filter.label]),
);
const filtersWithAll: Array<{
  slug: string;
  label: string;
  description?: string;
}> = [{ slug: "all", label: "All themes" }, ...filters];
const searchInputId = searchId ?? `pattern-search-${randomUUID()}`;
---

<div
  class="pattern-filter"
  data-pattern-filter
  data-filters={filters.map((filter) => filter.slug).join(",")}
  data-filter-labels={JSON.stringify(filterLabels)}
>
  <div class="pattern-filter__controls">
    <ul class="pill-list">
      {
        filtersWithAll.map((filter) => {
          const isAll = filter.slug === "all";

          return (
            <li
              class={`pill-list__item${isAll ? " pill-list__item--active" : ""}`}
            >
              <button
                type="button"
                class="pill-list__button"
                aria-pressed={isAll}
                data-filter={filter.slug}
                aria-label={
                  filter.slug === "all"
                    ? "Show all mechanisms"
                    : `Filter mechanisms by ${filter.label} and update visible results`
                }
              >
                {filter.label}
              </button>
              {!isAll && filter.description ? (
                <p class="muted small pattern-filter__description">
                  {filter.description}
                </p>
              ) : null}
            </li>
          );
        })
      }
    </ul>
    <label class="pattern-filter__search" for={searchInputId}>
      <span class="muted">Search mechanisms</span>
      <input
        id={searchInputId}
        type="search"
        class="pattern-filter__search-input"
        placeholder="Search by title, summary, or cue"
        data-search-input
        aria-label="Search mechanisms by title, summary, or cue"
      />
    </label>
    <p class="muted" role="status" aria-live="polite" data-filter-status>
      Showing all mechanisms.
    </p>
    <div class="pattern-filter__saved">
      <button
        class="button ghost button--compact"
        type="button"
        data-save-filters
      >
        Save filters
      </button>
      <button
        class="button ghost button--compact"
        type="button"
        data-restore-filters
      >
        Restore saved
      </button>
      <button
        class="button ghost button--compact"
        type="button"
        data-clear-filters
      >
        Clear filters
      </button>
      <p class="muted small" data-saved-status aria-live="polite">
        Filters are stored locally.
      </p>
    </div>
    <div class="pattern-bundle" data-pattern-bundle>
      <div class="pattern-bundle__header">
        <div class="pattern-bundle__copy">
          <p class="muted">Mechanism bundle</p>
          <h3>Save selected mechanisms.</h3>
          <p class="muted small" data-selection-status aria-live="polite">
            No mechanisms selected yet.
          </p>
        </div>
        <div class="pattern-bundle__actions">
          <button class="button" type="button" data-download-bundle>
            Download markdown
          </button>
          <button class="button button--subtle" type="button" data-print-bundle>
            Save as PDF
          </button>
          <button class="copy-button" type="button" data-copy-bundle>
            Copy bundle link
          </button>
        </div>
      </div>
      <form class="pattern-bundle__email" data-email-form>
        <div class="pattern-bundle__email-row">
          <label
            class="pattern-bundle__email-label"
            for={`${searchInputId}-email`}
          >
            <span>Email the bundle link (optional)</span>
            <input
              id={`${searchInputId}-email`}
              name="bundle-email"
              type="email"
              inputmode="email"
              autocomplete="email"
              class="pattern-filter__search-input"
              placeholder="you@example.com"
              data-bundle-email
            />
          </label>
          <button class="button" type="submit" data-email-submit>
            Draft email
          </button>
        </div>
        <p class="muted small" data-email-status aria-live="polite">
          Selections stay on this device.
        </p>
      </form>
      <p class="muted small pattern-bundle__hint">
        <a class="pattern-bundle__link" href="#mechanisms" data-bundle-link>
          Current bundle link
        </a>
      </p>
    </div>
  </div>
  <div class="grid" data-pattern-results>
    {
      entries.map((pattern) => {
        const appliedFilters = pattern.filters
          .map((filter) => filterLabels[filter] ?? filter)
          .join(", ");
        const detailHref = `/mechanisms/patterns/${pattern.slug}`;
        const searchContent = [
          pattern.title,
          pattern.summary,
          pattern.cues.join(" "),
          pattern.steps.join(" "),
          pattern.artifacts
            .map((artifact) => `${artifact.name} ${artifact.purpose}`)
            .join(" "),
          pattern.glossaryRefs.map((slug) => getGlossaryLabel(slug)).join(" "),
          pattern.example.description,
        ]
          .join(" ")
          .toLowerCase();
        const glossaryAnchors = pattern.glossaryRefs.map((slug) => ({
          slug,
          label: getGlossaryLabel(slug),
          definition: getGlossaryDefinition(slug),
          href: glossaryEntryPermalink(slug),
        }));

        return (
          <article
            class="card"
            id={pattern.slug}
            data-pattern-card
            data-filters={pattern.filters.join(",")}
            data-search={searchContent}
          >
            <div class="card__glow" aria-hidden="true" />
            <div class="pattern-card__meta">
              <p class="muted">Filters: {appliedFilters}</p>
              <label
                class="pattern-card__select"
                for={`${pattern.slug}-bundle`}
              >
                <input
                  id={`${pattern.slug}-bundle`}
                  type="checkbox"
                  value={pattern.slug}
                  data-pattern-select
                  aria-label={`Save ${pattern.title} to your bundle`}
                />
                <span>Save to bundle</span>
              </label>
            </div>
            <h3>
              <a class="pattern-card__title" href={detailHref}>
                {pattern.title}
              </a>
            </h3>
            <p>{pattern.summary}</p>
            <div class="pattern-card__actions">
              <a
                class="button ghost button--compact"
                href={detailHref}
                aria-label={`Read the full ${pattern.title} mechanism`}
              >
                Read full mechanism
              </a>
            </div>
            {glossaryAnchors.length > 0 && (
              <p class="muted pattern-card__glossary">
                Glossary anchors:{" "}
                {glossaryAnchors.map((anchor, index) => {
                  const separator =
                    index < glossaryAnchors.length - 1 ? ", " : "";

                  return (
                    <span>
                      <a
                        href={anchor.href}
                        title={anchor.definition || undefined}
                      >
                        {anchor.label}
                      </a>
                      {separator}
                    </span>
                  );
                })}
              </p>
            )}
            <details class="pattern-card__teaser">
              <summary>Execution details</summary>
              <div class="pattern-card__section">
                <p class="muted small">Steps</p>
                <ol class="pattern-card__list">
                  {pattern.steps.map((cue) => (
                    <li>{cue}</li>
                  ))}
                </ol>
              </div>
              <div class="pattern-card__section">
                <p class="muted small">Artifacts</p>
                <ul class="pattern-card__list">
                  {pattern.artifacts.map((artifact) => (
                    <li>
                      <strong>{artifact.name}.</strong> {artifact.purpose}
                    </li>
                  ))}
                </ul>
              </div>
              <div class="pattern-card__section">
                <p class="muted small">Example usage</p>
                <p class="pattern-card__example">
                  <strong>{pattern.example.title}.</strong>{" "}
                  {pattern.example.description}
                </p>
              </div>
              <a class="pattern-card__link" href={detailHref}>
                Open mechanism detail
              </a>
            </details>
            <div class="pattern-card__diagnostics">
              <p class="muted">
                Diagnostics{" "}
                {pattern.diagnostics.map((slug, index) => {
                  const label = diagnosticTitles[slug] ?? slug;
                  const separator =
                    index < pattern.diagnostics.length - 1 ? ", " : "";

                  return (
                    <span>
                      <a href={`/diagnostics#${slug}`} data-diagnostic-link>
                        {label}
                      </a>
                      {separator}
                    </span>
                  );
                })}
              </p>
              <div class="pattern-card__diagnostics-actions">
                <button
                  class="copy-button"
                  type="button"
                  data-copy-diagnostics
                >
                  Copy diagnostic links
                </button>
                <span class="muted small" data-diagnostic-status aria-live="polite"></span>
              </div>
            </div>
            <script
              type="application/json"
              data-pattern-payload
              is:inline
              set:html={JSON.stringify({
                slug: pattern.slug,
                title: pattern.title,
                summary: pattern.summary,
                filters: pattern.filters,
                glossaryRefs: pattern.glossaryRefs,
                cues: pattern.cues,
                diagnostics: pattern.diagnostics,
                steps: pattern.steps,
                artifacts: pattern.artifacts,
                example: pattern.example,
              })}
            />
          </article>
        );
      })
    }
    <p class="muted" data-empty hidden>No mechanisms match your filters yet.</p>
  </div>
</div>

<script type="module" src={patternFilterScript} is:inline></script>
