---
import { randomUUID } from 'node:crypto';

import type { Pattern, PatternFilter } from '../content/library';
import patternFilterScript from '../scripts/pattern-filter.ts?url';

type Props = {
  filters: PatternFilter[];
  entries: Pattern[];
  diagnosticTitles: Record<string, string>;
  searchId?: string;
};

const { filters, entries, diagnosticTitles, searchId } = Astro.props as Props;
const filterLabels = Object.fromEntries(
  filters.map((filter) => [filter.slug, filter.label])
);
const filtersWithAll: Array<{ slug: string; label: string; description?: string }> = [
  { slug: 'all', label: 'All themes' },
  ...filters,
];
const searchInputId = searchId ?? `pattern-search-${randomUUID()}`;
---
<div
  class="pattern-filter"
  data-pattern-filter
  data-filters={filters.map((filter) => filter.slug).join(',')}
  data-filter-labels={JSON.stringify(filterLabels)}
>
  <div class="pattern-filter__controls">
    <ul class="pill-list">
      {filtersWithAll.map((filter) => {
        const isAll = filter.slug === 'all';

        return (
          <li class={`pill-list__item${isAll ? ' pill-list__item--active' : ''}`}>
            <button
              type="button"
              class="pill-list__button"
              aria-pressed={isAll}
              data-filter={filter.slug}
              aria-label={
                filter.slug === 'all'
                  ? 'Show all patterns'
                  : `Filter patterns by ${filter.label} and update visible results`
              }
            >
              {filter.label}
            </button>
            {!isAll && filter.description ? (
              <p class="muted small pattern-filter__description">{filter.description}</p>
            ) : null}
          </li>
        );
      })}
    </ul>
    <label class="pattern-filter__search" for={searchInputId}>
      <span class="muted">Search patterns</span>
      <input
        id={searchInputId}
        type="search"
        class="pattern-filter__search-input"
        placeholder="Search by title, summary, or cue"
        data-search-input
        aria-label="Search patterns by title, summary, or cue"
      />
    </label>
    <p class="muted" role="status" aria-live="polite" data-filter-status>
      Showing all patterns.
    </p>
  </div>
  <div class="grid" data-pattern-results>
    {entries.map((pattern) => {
      const appliedFilters = pattern.filters
        .map((filter) => filterLabels[filter] ?? filter)
        .join(', ');
      const detailHref = `/library/patterns/${pattern.slug}`;
      const teaserSteps = pattern.steps.slice(0, 2);
      const searchContent = [
        pattern.title,
        pattern.summary,
        pattern.cues.join(' '),
        pattern.steps.join(' '),
        pattern.artifacts.map((artifact) => `${artifact.name} ${artifact.purpose}`).join(' '),
        pattern.example.description,
      ]
        .join(' ')
        .toLowerCase();

      return (
        <article
          class="card"
          id={pattern.slug}
          data-pattern-card
          data-filters={pattern.filters.join(',')}
          data-search={searchContent}
        >
          <div class="card__glow" aria-hidden="true" />
          <p class="muted">Filters: {appliedFilters}</p>
          <h3>
            <a class="pattern-card__title" href={detailHref}>
              {pattern.title}
            </a>
          </h3>
          <p>{pattern.summary}</p>
          <details class="pattern-card__teaser">
            <summary>Preview steps</summary>
            <ul class="pill-list">
              {teaserSteps.map((cue) => (
                <li>{cue}</li>
              ))}
            </ul>
            <p class="muted pattern-card__example">Example: {pattern.example.title}</p>
            <a class="pattern-card__link" href={detailHref}>
              Open pattern detail
            </a>
          </details>
          <p class="muted">
            Diagnostics{' '}
            {pattern.diagnostics.map((slug, index) => {
              const label = diagnosticTitles[slug] ?? slug;
              const separator = index < pattern.diagnostics.length - 1 ? ', ' : '';

              return (
                <span>
                  <a href={`/diagnostics#${slug}`}>{label}</a>
                  {separator}
                </span>
              );
            })}
          </p>
        </article>
      );
    })}
    <p class="muted" data-empty hidden>
      No patterns match your filters yet.
    </p>
  </div>
</div>

<script type="module" src={patternFilterScript}></script>
