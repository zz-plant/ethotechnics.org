---
import BaseLayout from "../layouts/BaseLayout.astro";
import CardGrid from "./CardGrid.astro";
import CardItem from "./CardItem.astro";
import PageIntro from "./PageIntro.astro";
import SectionBlock from "./SectionBlock.astro";
import {
  taxonomyEntries,
  taxonomyEntriesBySlug,
  type TaxonomyEntry,
} from "../content/taxonomy";

interface Props {
  entry: TaxonomyEntry;
  basePath?: string;
  eyebrow?: string;
  titleSuffix?: string;
}

const {
  entry,
  basePath = "",
  eyebrow = "Taxonomy",
  titleSuffix = " â€” Ethotechnics Institute",
} = Astro.props as Props;

const normalizedBasePath =
  basePath && basePath !== "/" ? basePath.replace(/\/$/, "") : "";

const entryPath = normalizedBasePath
  ? `${normalizedBasePath}/${entry.slug}`
  : `/${entry.slug}`;

const entryUrlForSlug = (slug: string) =>
  normalizedBasePath ? `${normalizedBasePath}/${slug}` : `/${slug}`;

const segments = entry.slug.split("/");
const parentSlug =
  segments.length > 1 ? segments.slice(0, -1).join("/") : null;
const parentEntry = parentSlug ? taxonomyEntriesBySlug.get(parentSlug) : null;
const basePathRoot =
  normalizedBasePath && normalizedBasePath !== "/taxonomy"
    ? normalizedBasePath.replace(/^\//, "")
    : "";
const parentPathSlug =
  parentEntry && basePathRoot && parentEntry.slug.startsWith(`${basePathRoot}/`)
    ? parentEntry.slug.replace(`${basePathRoot}/`, "")
    : parentEntry?.slug;

const siteBase = Astro.site ? Astro.site.toString() : Astro.url.origin;
const canonicalUrl = Astro.site
  ? new URL(entryPath, siteBase).toString()
  : entryPath;
const collectionPath =
  normalizedBasePath === "/taxonomy"
    ? "/taxonomy"
    : parentPathSlug
      ? entryUrlForSlug(parentPathSlug)
      : normalizedBasePath || "/taxonomy";
const collectionUrl = Astro.site
  ? new URL(collectionPath, siteBase).toString()
  : collectionPath;
const { cspNonce } = Astro.locals;

const siblingEntries = taxonomyEntries.filter((candidate) => {
  if (candidate.slug === entry.slug) {
    return false;
  }

  const candidateParent =
    candidate.slug.split("/").slice(0, -1).join("/") || null;

  return candidateParent === parentSlug;
});

const childEntries = taxonomyEntries.filter((candidate) => {
  return (
    candidate.slug.startsWith(`${entry.slug}/`) &&
    candidate.slug.split("/").length === segments.length + 1
  );
});

const pageTitle = `${entry.title}${titleSuffix}`;
const pageDescription = entry.summary;
const permalink = entryPath;

const anchorLinks = [
  { href: "#summary", label: "Summary" },
  { href: "#metadata", label: "Metadata" },
  { href: "#artifacts", label: "Related artifacts" },
  { href: "#navigation", label: "Navigation" },
];

const levelLabel = segments.length === 1 ? "Domain" : `Level ${segments.length}`;

const collectionLabel =
  normalizedBasePath === "/taxonomy"
    ? "Taxonomy"
    : parentEntry?.title ?? entry.title;

const breadcrumbItems = [
  {
    name: "Home",
    url: Astro.site ? new URL("/", siteBase).toString() : "/",
  },
  {
    name: collectionLabel,
    url: collectionUrl,
  },
  {
    name: entry.title,
    url: canonicalUrl,
  },
];

const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "CollectionPage",
      "@id": `${collectionUrl}#collection`,
      name: `${collectionLabel} taxonomy`,
      url: collectionUrl,
    },
    {
      "@type": "CreativeWork",
      "@id": `${canonicalUrl}#taxonomy-entry`,
      name: entry.title,
      description: entry.summary,
      identifier: entry.id,
      url: canonicalUrl,
      isPartOf: {
        "@id": `${collectionUrl}#collection`,
      },
    },
    {
      "@type": "BreadcrumbList",
      itemListElement: breadcrumbItems.map((item, index) => ({
        "@type": "ListItem",
        position: index + 1,
        name: item.name,
        item: item.url,
      })),
    },
  ],
};
const structuredDataJson = JSON.stringify(structuredData);
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  breadcrumbItems={breadcrumbItems}
>
  <Fragment slot="head">
    <script
      type="application/ld+json"
      nonce={cspNonce}
      set:html={structuredDataJson}
      is:inline
    />
  </Fragment>
  <PageIntro
    eyebrow={eyebrow}
    title={entry.title}
    description={entry.summary}
    permalink={permalink}
    anchorLinks={anchorLinks}
    panelCopy={{
      eyebrow: "Metadata",
      title: levelLabel,
      description: `Owner: ${entry.owner}. Scope: ${entry.scope}. Readiness: ${entry.readiness}.`,
      link: parentEntry
        ? {
            label: `Parent level: ${parentEntry.title}`,
            href: entryUrlForSlug(parentEntry.slug),
          }
        : undefined,
    }}
  />

  <SectionBlock
    id="summary"
    eyebrow="Summary"
    title="Scope overview"
    description="Use this statement to align teams on what this taxonomy level includes."
  >
    <div class="panel">
      <p>{entry.summary}</p>
    </div>
  </SectionBlock>

  <SectionBlock
    id="metadata"
    eyebrow="Metadata"
    title="Ownership and readiness"
    description="Capture the steward, scope, and readiness for this taxonomy level."
    variant="alt"
  >
    <dl class="standard-definitions">
      <div>
        <dt>Owner</dt>
        <dd>{entry.owner}</dd>
      </div>
      <div>
        <dt>Scope</dt>
        <dd>{entry.scope}</dd>
      </div>
      <div>
        <dt>Readiness</dt>
        <dd>{entry.readiness}</dd>
      </div>
    </dl>
  </SectionBlock>

  <SectionBlock
    id="artifacts"
    eyebrow="Related artifacts"
    title="Assets that reinforce this level"
    description="Link to the standards, tools, and references that define expected outcomes."
  >
    <CardGrid className="grid--two">
      {entry.relatedArtifacts.map((artifact) => (
        <CardItem
          eyebrow={artifact.type}
          title={artifact.label}
          description="Reference this artifact to align delivery and audits."
          descriptionTone="default"
        >
          <p class="muted">
            <a href={artifact.href}>Open the {artifact.type}</a>
          </p>
        </CardItem>
      ))}
    </CardGrid>
  </SectionBlock>

  <SectionBlock
    id="navigation"
    eyebrow="Navigation"
    title="Adjacent taxonomy levels"
    description="Move between parent, sibling, and child levels for consistent coverage."
    variant="alt"
  >
    <CardGrid className="grid--three">
      <CardItem title="Parent level" descriptionTone="default">
        {parentEntry ? (
          <p class="muted">
            <a href={entryUrlForSlug(parentEntry.slug)}>{parentEntry.title}</a>
          </p>
        ) : (
          <p class="muted">This is a top-level domain with no parent.</p>
        )}
      </CardItem>
      <CardItem title="Sibling levels" descriptionTone="default">
        {siblingEntries.length > 0 ? (
          <ul class="pill-list pill-list--wrap">
            {siblingEntries.map((sibling) => (
              <li>
                <a href={entryUrlForSlug(sibling.slug)}>{sibling.title}</a>
              </li>
            ))}
          </ul>
        ) : (
          <p class="muted">No siblings at this level yet.</p>
        )}
      </CardItem>
      <CardItem title="Child levels" descriptionTone="default">
        {childEntries.length > 0 ? (
          <ul class="pill-list pill-list--wrap">
            {childEntries.map((child) => (
              <li>
                <a href={entryUrlForSlug(child.slug)}>{child.title}</a>
              </li>
            ))}
          </ul>
        ) : (
          <p class="muted">No child levels defined beneath this entry.</p>
        )}
      </CardItem>
    </CardGrid>
  </SectionBlock>
</BaseLayout>
